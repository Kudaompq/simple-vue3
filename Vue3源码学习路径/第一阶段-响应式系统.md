# ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å“åº”å¼ç³»ç»Ÿ

## ğŸ¯ é˜¶æ®µç›®æ ‡
æ·±å…¥ç†è§£Vue 3å“åº”å¼ç³»ç»Ÿçš„æ ¸å¿ƒåŸç†ï¼ŒæŒæ¡Proxyã€ä¾èµ–æ”¶é›†ã€æ´¾å‘æ›´æ–°ç­‰å…³é”®æ¦‚å¿µã€‚

## ğŸ” æ ¸å¿ƒé—®é¢˜

### é—®é¢˜1ï¼šä»€ä¹ˆæ˜¯å“åº”å¼ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å“åº”å¼ï¼Ÿ
**å­¦ä¹ é‡ç‚¹ï¼š**
- ç†è§£å“åº”å¼ç¼–ç¨‹çš„æ¦‚å¿µ
- å¯¹æ¯”Vue 2å’ŒVue 3çš„å“åº”å¼å·®å¼‚
- ç†è§£Proxyç›¸æ¯”Object.definePropertyçš„ä¼˜åŠ¿

**å®è·µä»»åŠ¡ï¼š**
```javascript
// å®ç°ä¸€ä¸ªæœ€ç®€å•çš„å“åº”å¼å¯¹è±¡
const data = { count: 0 }
const reactiveData = makeReactive(data)

// å½“æ•°æ®å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡ŒæŸäº›æ“ä½œ
effect(() => {
  console.log('count is:', reactiveData.count)
})

reactiveData.count++ // åº”è¯¥è‡ªåŠ¨æ‰“å°æ–°å€¼
```

**ç­”æ¡ˆï¼š**

#### ä»€ä¹ˆæ˜¯å“åº”å¼ï¼Ÿ
å“åº”å¼ç¼–ç¨‹æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯**å½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè‡ªåŠ¨è§¦å‘ç›¸å…³è”çš„æ›´æ–°æ“ä½œ**ã€‚åœ¨å‰ç«¯æ¡†æ¶ä¸­ï¼Œå“åº”å¼ç³»ç»Ÿèƒ½å¤Ÿè‡ªåŠ¨è¿½è¸ªæ•°æ®ä¾èµ–å…³ç³»ï¼Œå½“æ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°è§†å›¾æˆ–æ‰§è¡Œç›¸å…³çš„å‰¯ä½œç”¨å‡½æ•°ã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦å“åº”å¼ï¼Ÿ
1. **è‡ªåŠ¨åŒ–æ›´æ–°**ï¼šæ— éœ€æ‰‹åŠ¨ç®¡ç†æ•°æ®å˜åŒ–å’Œè§†å›¾æ›´æ–°çš„å…³ç³»
2. **ç®€åŒ–å¼€å‘**ï¼šå¼€å‘è€…åªéœ€å…³æ³¨æ•°æ®é€»è¾‘ï¼Œæ¡†æ¶è‡ªåŠ¨å¤„ç†UIæ›´æ–°
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šç²¾ç¡®è¿½è¸ªä¾èµ–ï¼Œåªæ›´æ–°çœŸæ­£éœ€è¦æ›´æ–°çš„éƒ¨åˆ†
4. **ä»£ç å¯ç»´æŠ¤æ€§**ï¼šæ•°æ®æµå‘æ¸…æ™°ï¼Œå‡å°‘æ‰‹åŠ¨DOMæ“ä½œ

#### Vue 2 vs Vue 3 å“åº”å¼å¯¹æ¯”

**Vue 2 (Object.defineProperty)**ï¼š
```javascript
// Vue 2 çš„å±€é™æ€§
const data = { count: 0 }
Object.defineProperty(data, 'count', {
  get() { /* ä¾èµ–æ”¶é›† */ },
  set(newVal) { /* è§¦å‘æ›´æ–° */ }
})

// é—®é¢˜ï¼š
// 1. æ— æ³•æ£€æµ‹å±æ€§çš„æ·»åŠ /åˆ é™¤
data.newProp = 'value' // âŒ ä¸ä¼šè§¦å‘æ›´æ–°
delete data.count // âŒ ä¸ä¼šè§¦å‘æ›´æ–°

// 2. æ•°ç»„ç´¢å¼•å’Œé•¿åº¦å˜åŒ–æ£€æµ‹å›°éš¾
data.arr[0] = 'new' // âŒ ä¸ä¼šè§¦å‘æ›´æ–°
data.arr.length = 0 // âŒ ä¸ä¼šè§¦å‘æ›´æ–°
```

**Vue 3 (Proxy)**ï¼š
```javascript
// Vue 3 çš„ä¼˜åŠ¿
const data = new Proxy({ count: 0 }, {
  get(target, key) { /* ä¾èµ–æ”¶é›† */ },
  set(target, key, value) { /* è§¦å‘æ›´æ–° */ },
  deleteProperty(target, key) { /* åˆ é™¤å±æ€§ä¹Ÿèƒ½æ£€æµ‹ */ }
})

// ä¼˜åŠ¿ï¼š
// 1. å®Œæ•´çš„å¯¹è±¡æ“ä½œæ‹¦æˆª
data.newProp = 'value' // âœ… èƒ½å¤Ÿæ£€æµ‹
delete data.count // âœ… èƒ½å¤Ÿæ£€æµ‹

// 2. åŸç”Ÿæ•°ç»„æ“ä½œæ”¯æŒ
data.arr[0] = 'new' // âœ… èƒ½å¤Ÿæ£€æµ‹
data.arr.push('item') // âœ… èƒ½å¤Ÿæ£€æµ‹
```

#### Proxy ç›¸æ¯” Object.defineProperty çš„æ ¸å¿ƒä¼˜åŠ¿
1. **æ‹¦æˆªèŒƒå›´æ›´å¹¿**ï¼š13ç§æ“ä½œ vs 2ç§æ“ä½œ
2. **æ€§èƒ½æ›´å¥½**ï¼šä¸éœ€è¦é€’å½’éå†æ‰€æœ‰å±æ€§
3. **åŸç”Ÿæ•°ç»„æ”¯æŒ**ï¼šæ— éœ€ç‰¹æ®Šå¤„ç†æ•°ç»„æ–¹æ³•
4. **åŠ¨æ€å±æ€§æ”¯æŒ**ï¼šæ–°å¢/åˆ é™¤å±æ€§è‡ªåŠ¨å“åº”å¼
5. **æ›´å¥½çš„ç±»å‹æ”¯æŒ**ï¼šæ”¯æŒ Mapã€Set ç­‰æ•°æ®ç»“æ„

![alt text](assets/image.png)

### é—®é¢˜2ï¼šProxyæ˜¯å¦‚ä½•æ‹¦æˆªå¯¹è±¡æ“ä½œçš„ï¼Ÿ
**å­¦ä¹ é‡ç‚¹ï¼š**
- Proxyçš„åŸºæœ¬ç”¨æ³•å’Œæ‰€æœ‰æ‹¦æˆªå™¨
- getã€setã€hasã€deletePropertyç­‰æ‹¦æˆªå™¨çš„ä½œç”¨
- Reflectçš„ä½œç”¨å’Œä¸ºä»€ä¹ˆè¦é…åˆä½¿ç”¨

**å®è·µä»»åŠ¡ï¼š**
```javascript
// å®ç°ä¸€ä¸ªèƒ½æ‹¦æˆªæ‰€æœ‰æ“ä½œçš„Proxy
const obj = { name: 'Vue', version: 3 }
const proxied = new Proxy(obj, {
  get(target, key, receiver) {
    console.log(`è¯»å–å±æ€§: ${key}`)
    // æ€è€ƒï¼šä¸ºä»€ä¹ˆè¦ç”¨Reflect.getè€Œä¸æ˜¯target[key]ï¼Ÿ
    /**
     * thisæŒ‡å‘é—®é¢˜ï¼š
     * åœ¨Proxyçš„get/setæ‹¦æˆªå™¨ä¸­ï¼ŒthisæŒ‡å‘çš„æ˜¯åŸå§‹å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä»£ç†å¯¹è±¡ã€‚
     * ä½¿ç”¨Reflect.getå¯ä»¥ç¡®ä¿thisæŒ‡å‘æ­£ç¡®çš„ä»£ç†å¯¹è±¡
     * è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨è®¿é—®å±æ€§æ—¶ï¼Œèƒ½å¤Ÿæ­£ç¡®åœ°è·å–åˆ°ä»£ç†å¯¹è±¡çš„
     */
  },
  set(target, key, value, receiver) {
    console.log(`è®¾ç½®å±æ€§: ${key} = ${value}`)
    // æ€è€ƒï¼šå¦‚ä½•åˆ¤æ–­æ˜¯æ–°å¢å±æ€§è¿˜æ˜¯ä¿®æ”¹å±æ€§ï¼Ÿ
    // è²Œä¼¼ä¸éœ€è¦åˆ¤æ–­ï¼ŒProxyä¼šè‡ªåŠ¨å¤„ç†
    return Reflect.set(target, key, value, receiver)
  }
  // ... å…¶ä»–æ‹¦æˆªå™¨
})
```
**ç­”æ¡ˆï¼š**

#### Proxy æ‹¦æˆªå™¨è¯¦è§£

Proxy æä¾›äº† 13 ç§æ‹¦æˆªå™¨ï¼Œè¦†ç›–äº†å¯¹è±¡çš„æ‰€æœ‰åŸºæœ¬æ“ä½œï¼š

```javascript
const proxy = new Proxy(target, {
  // å±æ€§è®¿é—®æ‹¦æˆª
  get(target, key, receiver) {
    console.log(`è®¿é—®å±æ€§: ${key}`)
    return Reflect.get(target, key, receiver)
  },
  
  // å±æ€§è®¾ç½®æ‹¦æˆª
  set(target, key, value, receiver) {
    console.log(`è®¾ç½®å±æ€§: ${key} = ${value}`)
    return Reflect.set(target, key, value, receiver)
  },
  
  // å±æ€§æ£€æŸ¥æ‹¦æˆª
  has(target, key) {
    console.log(`æ£€æŸ¥å±æ€§: ${key}`)
    return Reflect.has(target, key)
  },
  
  // å±æ€§åˆ é™¤æ‹¦æˆª
  deleteProperty(target, key) {
    console.log(`åˆ é™¤å±æ€§: ${key}`)
    return Reflect.deleteProperty(target, key)
  },
  
  // å…¶ä»–æ‹¦æˆªå™¨ï¼šownKeys, getPrototypeOf, setPrototypeOf ç­‰
})
```

#### ä¸ºä»€ä¹ˆå¿…é¡»é…åˆ Reflectï¼Ÿ

**1. æ­£ç¡®çš„ this æŒ‡å‘**
```javascript
const obj = {
  name: 'Vue',
  getName() {
    return this.name // this åº”è¯¥æŒ‡å‘ä»£ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯åŸå§‹å¯¹è±¡
  }
}

const proxy = new Proxy(obj, {
  get(target, key, receiver) {
    // âŒ é”™è¯¯æ–¹å¼ï¼šthis æŒ‡å‘åŸå§‹å¯¹è±¡
    // return target[key]
    
    // âœ… æ­£ç¡®æ–¹å¼ï¼šthis æŒ‡å‘ä»£ç†å¯¹è±¡
    return Reflect.get(target, key, receiver)
  }
})
```

**2. æ­£ç¡®çš„è¿”å›å€¼å¤„ç†**
```javascript
const proxy = new Proxy({}, {
  set(target, key, value, receiver) {
    // Reflect.set è¿”å› booleanï¼Œè¡¨ç¤ºæ“ä½œæ˜¯å¦æˆåŠŸ
    const result = Reflect.set(target, key, value, receiver)
    if (result) {
      // åªæœ‰è®¾ç½®æˆåŠŸæ‰è§¦å‘æ›´æ–°
      trigger(target, key)
    }
    return result
  }
})
```

**3. åŸå‹é“¾çš„æ­£ç¡®å¤„ç†**
```javascript
// å½“è®¿é—®ç»§æ‰¿å±æ€§æ—¶ï¼ŒReflect ç¡®ä¿æ­£ç¡®çš„åŸå‹é“¾æŸ¥æ‰¾
const parent = { parentProp: 'parent' }
const child = Object.create(parent)
const proxy = new Proxy(child, {
  get(target, key, receiver) {
    // Reflect.get ä¼šæ­£ç¡®å¤„ç†åŸå‹é“¾æŸ¥æ‰¾
    return Reflect.get(target, key, receiver)
  }
})
```

#### åˆ¤æ–­æ–°å¢ vs ä¿®æ”¹å±æ€§
```javascript
set(target, key, value, receiver) {
  const hadKey = Object.prototype.hasOwnProperty.call(target, key)
  const oldValue = target[key]
  const result = Reflect.set(target, key, value, receiver)
  
  if (!hadKey) {
    console.log(`æ–°å¢å±æ€§: ${key}`)
    // è§¦å‘ ADD ç±»å‹çš„æ›´æ–°
  } else if (value !== oldValue) {
    console.log(`ä¿®æ”¹å±æ€§: ${key}`)
    // è§¦å‘ SET ç±»å‹çš„æ›´æ–°
  }
  
  return result
}
```


### é—®é¢˜3ï¼šä¾èµ–æ”¶é›†æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ
**å­¦ä¹ é‡ç‚¹ï¼š**
- ä»€ä¹ˆæ˜¯ä¾èµ–æ”¶é›†ï¼Ÿ
- effectå‡½æ•°çš„ä½œç”¨å’Œå®ç°åŸç†
- trackå‡½æ•°å¦‚ä½•æ”¶é›†dependencies
- ä¾èµ–æ”¶é›†çš„æ•°æ®ç»“æ„è®¾è®¡

**å®è·µä»»åŠ¡ï¼š**
```javascript
// å®ç°ä¾èµ–æ”¶é›†ç³»ç»Ÿ
let activeEffect = null
const targetMap = new WeakMap()

function effect(fn) {
  activeEffect = fn
  fn() // æ‰§è¡Œå‡½æ•°ï¼Œè§¦å‘getæ‹¦æˆªå™¨ï¼Œè¿›è¡Œä¾èµ–æ”¶é›†
  activeEffect = null
}

function track(target, key) {
  // æ€è€ƒï¼šå¦‚ä½•å»ºç«‹target -> key -> effectsçš„æ˜ å°„å…³ç³»ï¼Ÿ
  /**
   *  targetMapæ˜¯ä¸€ä¸ªWeakMapï¼Œkeyæ˜¯targetå¯¹è±¡ï¼Œvalueæ˜¯ä¸€ä¸ªMapï¼Œ
   *  Mapçš„keyæ˜¯å±æ€§åï¼Œvalueæ˜¯ä¸€ä¸ªSetï¼ˆæºç ä¸­æ˜¯depï¼Œå†…éƒ¨ä¹Ÿæ˜¯ä¸€ä¸ªSetï¼‰ï¼Œå­˜å‚¨æ‰€æœ‰ä¾èµ–äºè¿™ä¸ªå±æ€§çš„effectå‡½æ•°ã€‚
   *  è¿™æ ·å¯ä»¥ç¡®ä¿æ¯ä¸ªtargetå’Œkeyçš„ç»„åˆåªå­˜å‚¨ä¸€æ¬¡effectå‡½æ•°ï¼Œé¿å…é‡å¤æ‰§è¡Œã€‚
   *  WeakMapçš„ä¼˜åŠ¿æ˜¯å¯ä»¥è‡ªåŠ¨æ¸…ç†ä¸å†ä½¿ç”¨çš„targetå¯¹è±¡ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚
   * /
  // æ€è€ƒï¼šä¸ºä»€ä¹ˆä½¿ç”¨WeakMapè€Œä¸æ˜¯Mapï¼Ÿ
}
```
**ç­”æ¡ˆï¼š**

#### ä¾èµ–æ”¶é›†çš„æ ¸å¿ƒæ¦‚å¿µ

ä¾èµ–æ”¶é›†æ˜¯å“åº”å¼ç³»ç»Ÿçš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒåœ¨**æ•°æ®è®¿é—®æ—¶**è‡ªåŠ¨å»ºç«‹**æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°**ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚

#### æ•°æ®ç»“æ„è®¾è®¡

```javascript
// å…¨å±€ä¾èµ–æ˜ å°„ï¼šWeakMap<target, Map<key, Set<effect>>>
const targetMap = new WeakMap()

// ç»“æ„ç¤ºæ„ï¼š
// targetMap: {
//   obj1: Map {
//     'name': Set { effect1, effect2 },
//     'age': Set { effect1 }
//   },
//   obj2: Map {
//     'count': Set { effect3 }
//   }
// }
```

#### effect å‡½æ•°å®ç°åŸç†

```javascript
let activeEffect = null
let effectStack = [] // è§£å†³åµŒå¥— effect é—®é¢˜

export function effect(fn, options = {}) {
  const effectFn = () => {
    // 1. æ¸…ç†ä¹‹å‰çš„ä¾èµ–ï¼Œé¿å…å†…å­˜æ³„æ¼
    cleanup(effectFn)
    
    try {
      // 2. å¤„ç†åµŒå¥— effect
      effectStack.push(activeEffect)
      activeEffect = effectFn
      
      // 3. æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œè§¦å‘ä¾èµ–æ”¶é›†
      return fn()
    } finally {
      // 4. æ¢å¤ä¸Šä¸€ä¸ª effect
      effectStack.pop()
      activeEffect = effectStack[effectStack.length - 1]
    }
  }
  
  // 5. ä¸º effect æ·»åŠ ä¾èµ–åˆ—è¡¨ï¼Œç”¨äºæ¸…ç†
  effectFn.deps = []
  
  // 6. æ”¯æŒæ‡’æ‰§è¡Œï¼ˆcomputed éœ€è¦ï¼‰
  if (!options.lazy) {
    effectFn()
  }
  
  return effectFn
}
```

#### track å‡½æ•°å®ç°

```javascript
export function track(target, key) {
  // 1. æ²¡æœ‰æ¿€æ´»çš„ effectï¼Œæ— éœ€æ”¶é›†
  if (!activeEffect) return
  
  // 2. è·å–æˆ–åˆ›å»º target å¯¹åº”çš„ä¾èµ– Map
  let deps = targetMap.get(target)
  if (!deps) {
    targetMap.set(target, (deps = new Map()))
  }
  
  // 3. è·å–æˆ–åˆ›å»º key å¯¹åº”çš„ä¾èµ– Set
  let dep = deps.get(key)
  if (!dep) {
    deps.set(key, (dep = new Set()))
  }
  
  // 4. å»ºç«‹åŒå‘è¿æ¥
  dep.add(activeEffect)           // effect ä¾èµ–è¿™ä¸ªå±æ€§
  activeEffect.deps.push(dep)     // å±æ€§è¢«è¿™ä¸ª effect ä¾èµ–
}
```

#### ä¸ºä»€ä¹ˆä½¿ç”¨ WeakMapï¼Ÿ

1. **è‡ªåŠ¨åƒåœ¾å›æ”¶**ï¼šå½“ target å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œå¯¹åº”çš„ä¾èµ–å…³ç³»ä¹Ÿä¼šè¢«è‡ªåŠ¨æ¸…ç†
2. **é¿å…å†…å­˜æ³„æ¼**ï¼šä¸ä¼šå› ä¸ºä¾èµ–æ˜ å°„è€Œé˜»æ­¢å¯¹è±¡è¢«å›æ”¶
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šWeakMap çš„æŸ¥æ‰¾æ€§èƒ½ä¼˜äºæ™®é€šå¯¹è±¡

```javascript
// ç¤ºä¾‹ï¼šå¯¹è±¡é”€æ¯æ—¶è‡ªåŠ¨æ¸…ç†
let obj = { count: 0 }
const reactiveObj = reactive(obj)

effect(() => {
  console.log(reactiveObj.count) // å»ºç«‹ä¾èµ–å…³ç³»
})

// å½“ obj è¢«é”€æ¯æ—¶ï¼ŒtargetMap ä¸­çš„å¯¹åº”æ¡ç›®ä¹Ÿä¼šè¢«è‡ªåŠ¨æ¸…ç†
obj = null
reactiveObj = null // WeakMap ä¼šè‡ªåŠ¨æ¸…ç†ç›¸å…³ä¾èµ–
```

#### å®Œæ•´çš„ä¾èµ–æ”¶é›†æµç¨‹

```javascript
// 1. åˆ›å»ºå“åº”å¼å¯¹è±¡
const state = reactive({ count: 0 })

// 2. åˆ›å»ºå‰¯ä½œç”¨å‡½æ•°
effect(() => {
  console.log('count:', state.count) // è§¦å‘ get æ‹¦æˆªå™¨
})

// æµç¨‹ï¼š
// effect() â†’ è®¾ç½® activeEffect â†’ æ‰§è¡Œ fn() â†’ è®¿é—® state.count 
// â†’ è§¦å‘ get æ‹¦æˆªå™¨ â†’ è°ƒç”¨ track(state, 'count') 
// â†’ å»ºç«‹ä¾èµ–å…³ç³» â†’ å®Œæˆæ”¶é›†
```


### é—®é¢˜4ï¼šæ´¾å‘æ›´æ–°æ˜¯å¦‚ä½•è§¦å‘çš„ï¼Ÿ
**å­¦ä¹ é‡ç‚¹ï¼š**
- triggerå‡½æ•°çš„å®ç°åŸç†
- æ•°ç»„æ“ä½œçš„ç‰¹æ®Šå¤„ç†

**å®è·µä»»åŠ¡ï¼š**
```javascript
function trigger(target, key, type) {
  // æ€è€ƒï¼šå¦‚ä½•æ‰¾åˆ°éœ€è¦æ‰§è¡Œçš„effectsï¼Ÿ
  /**
   *  targetMapå­˜å‚¨äº†æ‰€æœ‰å“åº”å¼å¯¹è±¡çš„ä¾èµ–å…³ç³»ï¼Œ
   * /
  // æ€è€ƒï¼šæ•°ç»„çš„lengthå˜åŒ–å¦‚ä½•å¤„ç†ï¼Ÿ
  /**
   * åˆ¤æ–­å±æ€§æ˜¯å¦æ˜¯Arrayï¼Œè®°å½•åŸæ¥æ•°ç»„çš„é•¿åº¦ï¼Œä¿®æ”¹ååˆ¤æ–­é•¿åº¦æ˜¯å¦å˜åŒ–ï¼Œå¦‚æœå˜åŒ–æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªlengthå±æ€§çš„æ›´æ–°
   * è¿™æ ·å¯ä»¥ç¡®ä¿æ•°ç»„çš„lengthå˜åŒ–æ—¶ï¼Œèƒ½å¤Ÿæ­£ç¡®è§¦å‘ä¾èµ–æ”¶
   * /
  // æ€è€ƒï¼šå¦‚ä½•é¿å…é‡å¤æ‰§è¡ŒåŒä¸€ä¸ªeffectï¼Ÿ
  /**
   * ä½¿ç”¨Setçš„æ•°æ®ç»“æ„æ¥å­˜å‚¨effectsï¼Œç¡®ä¿æ¯ä¸ªeffectåªæ‰§è¡Œä¸€æ¬¡ã€‚
   * è¿™æ ·å¯ä»¥é¿å…åœ¨åŒä¸€ä¸ªtriggerè°ƒç”¨ä¸­é‡å¤æ‰§è¡ŒåŒä¸€ä¸ªeffectã€‚
   */
}

// æµ‹è¯•ç”¨ä¾‹
const arr = reactive([1, 2, 3])
effect(() => {
  console.log('æ•°ç»„é•¿åº¦:', arr.length)
})
arr.push(4) // åº”è¯¥è§¦å‘effect
```
**ç­”æ¡ˆï¼š**

#### trigger å‡½æ•°å®ç°åŸç†

```javascript
export function trigger(target, key) {
  // 1. è·å– target å¯¹åº”çš„æ‰€æœ‰ä¾èµ–
  const deps = targetMap.get(target)
  if (!deps) return
  
  // 2. è·å– key å¯¹åº”çš„ä¾èµ–é›†åˆ
  const dep = deps.get(key)
  if (!dep) return
  
  // 3. åˆ›å»ºå‰¯æœ¬é¿å…æ— é™å¾ªç¯
  // å› ä¸º effect æ‰§è¡Œæ—¶å¯èƒ½ä¼šä¿®æ”¹ dep é›†åˆ
  const effectsToRun = new Set(dep)
  
  // 4. æ‰§è¡Œæ‰€æœ‰ç›¸å…³çš„å‰¯ä½œç”¨å‡½æ•°
  effectsToRun.forEach((effectFn) => {
    if (effectFn.scheduler) {
      // å¦‚æœæœ‰è°ƒåº¦å™¨ï¼Œä½¿ç”¨è°ƒåº¦å™¨æ‰§è¡Œ
      effectFn.scheduler(effectFn)
    } else {
      // å¦åˆ™ç›´æ¥æ‰§è¡Œ
      effectFn()
    }
  })
}
```

#### æ•°ç»„æ“ä½œçš„ç‰¹æ®Šå¤„ç†

åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œæ•°ç»„æ“ä½œé€šè¿‡ä»¥ä¸‹æ–¹å¼å¤„ç†ï¼š

```javascript
// reactive.js ä¸­çš„ set æ‹¦æˆªå™¨
set(target, key, value, receiver) {
  const oldValue = target[key]
  let oldLength
  
  // è®°å½•æ•°ç»„åŸå§‹é•¿åº¦
  if (isArray(target)) {
    oldLength = target.length
  }
  
  // æ‰§è¡Œè®¾ç½®æ“ä½œ
  const result = Reflect.set(target, key, value, receiver)
  
  // å€¼å‘ç”Ÿå˜åŒ–æ‰è§¦å‘æ›´æ–°
  if (hasChanged(value, oldValue)) {
    trigger(target, key)
    
    // æ•°ç»„é•¿åº¦å˜åŒ–çš„ç‰¹æ®Šå¤„ç†
    if (isArray(target) && target.length !== oldLength) {
      trigger(target, 'length') // é¢å¤–è§¦å‘ length ä¾èµ–
    }
  }
  
  return result
}
```

#### æ•°ç»„æ“ä½œç¤ºä¾‹

```javascript
const arr = reactive([1, 2, 3])

// ç›‘å¬æ•°ç»„é•¿åº¦
effect(() => {
  console.log('æ•°ç»„é•¿åº¦:', arr.length)
})

// ç›‘å¬ç‰¹å®šç´¢å¼•
effect(() => {
  console.log('ç¬¬ä¸€ä¸ªå…ƒç´ :', arr[0])
})

// å„ç§æ•°ç»„æ“ä½œçš„è§¦å‘æƒ…å†µï¼š
arr.push(4)      // è§¦å‘: length å’Œæ–°ç´¢å¼•çš„ä¾èµ–
arr[0] = 'new'   // è§¦å‘: ç´¢å¼• 0 çš„ä¾èµ–
arr.length = 2   // è§¦å‘: length å’Œè¢«åˆ é™¤ç´¢å¼•çš„ä¾èµ–
arr.splice(1, 1) // è§¦å‘: å¤šä¸ªç´¢å¼•å’Œ length çš„ä¾èµ–
```

#### é¿å…é‡å¤æ‰§è¡Œçš„æœºåˆ¶

```javascript
// ä½¿ç”¨ Set æ•°æ®ç»“æ„è‡ªåŠ¨å»é‡
const effectsToRun = new Set(dep)

// å³ä½¿åŒä¸€ä¸ª effect è¢«å¤šæ¬¡æ·»åŠ ï¼ŒSet ä¹Ÿåªä¼šä¿ç•™ä¸€ä¸ª
// ä¾‹å¦‚ï¼šä¿®æ”¹å¯¹è±¡çš„å¤šä¸ªå±æ€§ï¼ŒåŒä¸€ä¸ª effect åªæ‰§è¡Œä¸€æ¬¡
const state = reactive({ a: 1, b: 2 })
effect(() => {
  console.log(state.a + state.b) // ä¾èµ– a å’Œ b
})

// æ‰¹é‡ä¿®æ”¹æ—¶ï¼Œeffect åªæ‰§è¡Œä¸€æ¬¡
state.a = 10
state.b = 20
```

#### è°ƒåº¦å™¨çš„ä½œç”¨

```javascript
// æ”¯æŒè‡ªå®šä¹‰æ‰§è¡Œæ—¶æœº
effect(() => {
  console.log('ç«‹å³æ‰§è¡Œ')
}, {
  scheduler: (effect) => {
    // å»¶è¿Ÿåˆ°ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡æ‰§è¡Œ
    Promise.resolve().then(() => effect())
  }
})

// æˆ–è€…æ‰¹é‡æ‰§è¡Œ
const queue = []
let isFlushing = false

effect(() => {
  console.log('æ‰¹é‡æ‰§è¡Œ')
}, {
  scheduler: (effect) => {
    queue.push(effect)
    if (!isFlushing) {
      isFlushing = true
      Promise.resolve().then(() => {
        queue.forEach(fn => fn())
        queue.length = 0
        isFlushing = false
      })
    }
  }
})
```

### é—®é¢˜5ï¼šrefæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦refï¼Ÿ
**å­¦ä¹ é‡ç‚¹ï¼š**
- refçš„è®¾è®¡ç†å¿µå’Œä½¿ç”¨åœºæ™¯
- refå’Œreactiveçš„åŒºåˆ«
- .valueçš„å®ç°åŸç†

**å®è·µä»»åŠ¡ï¼š**
```javascript
// å®ç°ref
function ref(value) {
  // æ€è€ƒï¼šä¸ºä»€ä¹ˆåŸºæœ¬ç±»å‹éœ€è¦åŒ…è£…æˆå¯¹è±¡ï¼Ÿ
  /**
   * åŸºæœ¬ç±»å‹ï¼ˆå¦‚numberã€stringç­‰ï¼‰åœ¨JavaScriptä¸­æ˜¯ä¸å¯å˜çš„ï¼Œ
   * éœ€è¦é€šè¿‡å¯¹è±¡åŒ…è£…æ‰èƒ½å®ç°å“åº”å¼ã€‚
   * è¿™æ ·å¯ä»¥ç¡®ä¿å½“åŸºæœ¬ç±»å‹çš„å€¼å˜åŒ–æ—¶ï¼Œèƒ½å¤Ÿè§¦å‘ä¾èµ–æ”¶é›†å’Œæ›´æ–°ã€‚
   */
  // æ€è€ƒï¼šå¦‚ä½•å®ç°.valueçš„å“åº”å¼ï¼Ÿ
  /**
   * refè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªvalueå±æ€§ï¼Œ
   * å½“è®¿é—®.valueæ—¶ï¼Œä¼šè§¦å‘getæ‹¦æˆªå™¨ï¼Œè¿›è¡Œä¾èµ–æ”¶é›†ã€‚
   * å½“è®¾ç½®.valueæ—¶ï¼Œä¼šè§¦å‘setæ‹¦æˆªå™¨ï¼Œè¿›è¡Œæ´¾å‘æ›´æ–°ã€‚
   */
}

const count = ref(0)
effect(() => {
  console.log('count:', count.value)
})
count.value++ // åº”è¯¥è§¦å‘effect
```
**ç­”æ¡ˆï¼š**

#### ref çš„è®¾è®¡ç†å¿µ

ref è§£å†³äº† JavaScript åŸºæœ¬ç±»å‹æ— æ³•ç›´æ¥å“åº”å¼çš„é—®é¢˜ï¼Œé€šè¿‡**å¯¹è±¡åŒ…è£…**çš„æ–¹å¼è®©åŸºæœ¬ç±»å‹ä¹Ÿèƒ½å‚ä¸å“åº”å¼ç³»ç»Ÿã€‚

#### ä¸ºä»€ä¹ˆåŸºæœ¬ç±»å‹éœ€è¦åŒ…è£…ï¼Ÿ

```javascript
// åŸºæœ¬ç±»å‹çš„é—®é¢˜
let count = 0
effect(() => {
  console.log(count) // æ— æ³•å»ºç«‹å“åº”å¼è¿æ¥
})
count = 1 // ä¸ä¼šè§¦å‘ effect é‡æ–°æ‰§è¡Œ

// å¯¹è±¡ç±»å‹å¯ä»¥ç›´æ¥å“åº”å¼
const state = reactive({ count: 0 })
effect(() => {
  console.log(state.count) // å¯ä»¥å»ºç«‹å“åº”å¼è¿æ¥
})
state.count = 1 // ä¼šè§¦å‘ effect é‡æ–°æ‰§è¡Œ
```

#### ref çš„å®Œæ•´å®ç°

```javascript
const IS_REF = Symbol('isRef')

export function ref(value) {
  // å¦‚æœå·²ç»æ˜¯ refï¼Œç›´æ¥è¿”å›
  if (isRef(value)) {
    return value
  }
  return new RefImpl(value)
}

class RefImpl {
  constructor(value) {
    // å¦‚æœå€¼æ˜¯å¯¹è±¡ï¼Œè½¬æ¢ä¸ºå“åº”å¼å¯¹è±¡
    this._value = isObject(value) ? reactive(value) : value
    this[IS_REF] = true // æ ‡è®°ä¸º ref
  }
  
  get value() {
    // ä¾èµ–æ”¶é›†ï¼šå½“è®¿é—® .value æ—¶æ”¶é›†ä¾èµ–
    track(this, 'value')
    return this._value
  }
  
  set value(newValue) {
    // åªæœ‰å€¼çœŸæ­£æ”¹å˜æ—¶æ‰è§¦å‘æ›´æ–°
    if (hasChanged(newValue, this._value)) {
      // å¦‚æœæ–°å€¼æ˜¯å¯¹è±¡ï¼Œè½¬æ¢ä¸ºå“åº”å¼
      this._value = isObject(newValue) ? reactive(newValue) : newValue
      // è§¦å‘ä¾èµ–æ›´æ–°
      trigger(this, 'value')
    }
  }
}

export function isRef(value) {
  return !!(value && value[IS_REF])
}
```

#### ref vs reactive çš„åŒºåˆ«

| ç‰¹æ€§ | ref | reactive |
|------|-----|----------|
| **é€‚ç”¨ç±»å‹** | åŸºæœ¬ç±»å‹ + å¯¹è±¡ | ä»…å¯¹è±¡ç±»å‹ |
| **è®¿é—®æ–¹å¼** | `.value` | ç›´æ¥è®¿é—®å±æ€§ |
| **æ¨¡æ¿ä¸­** | è‡ªåŠ¨è§£åŒ… | ç›´æ¥ä½¿ç”¨ |
| **å“åº”å¼åŸç†** | å¯¹è±¡åŒ…è£… + getter/setter | Proxy æ‹¦æˆª |
| **åµŒå¥—å¯¹è±¡** | è‡ªåŠ¨è½¬ reactive | åŸç”Ÿæ”¯æŒ |

```javascript
// ref ç¤ºä¾‹
const count = ref(0)
const user = ref({ name: 'Vue' })

effect(() => {
  console.log(count.value)      // éœ€è¦ .value
  console.log(user.value.name)  // åµŒå¥—å¯¹è±¡ä¹Ÿéœ€è¦ .value
})

// reactive ç¤ºä¾‹
const state = reactive({ 
  count: 0, 
  user: { name: 'Vue' } 
})

effect(() => {
  console.log(state.count)      // ç›´æ¥è®¿é—®
  console.log(state.user.name)  // åµŒå¥—å¯¹è±¡ç›´æ¥è®¿é—®
})
```

#### ref çš„è‡ªåŠ¨è§£åŒ…æœºåˆ¶

åœ¨ reactive å¯¹è±¡ä¸­ï¼Œref ä¼šè‡ªåŠ¨è§£åŒ…ï¼š

```javascript
// reactive.js ä¸­çš„å¤„ç†
get(target, key, receiver) {
  track(target, key)
  const res = Reflect.get(target, key, receiver)
  
  // å¦‚æœæ˜¯ refï¼Œè‡ªåŠ¨è¿”å›å…¶ value
  if (isRef(res)) {
    return res.value
  }
  
  return isObject(res) ? reactive(res) : res
}

set(target, key, value, receiver) {
  // å¦‚æœç›®æ ‡å±æ€§æ˜¯ refï¼Œç›´æ¥è®¾ç½®å…¶ value
  if (isRef(target[key])) {
    target[key].value = value
    return true
  }
  
  // æ­£å¸¸è®¾ç½®æµç¨‹...
}
```

#### ä½¿ç”¨åœºæ™¯å¯¹æ¯”

```javascript
// 1. åŸºæœ¬ç±»å‹å“åº”å¼
const count = ref(0)
const message = ref('Hello')

// 2. å•ä¸€å¯¹è±¡å“åº”å¼
const user = ref({ name: 'Vue', age: 3 })

// 3. å¤æ‚å¯¹è±¡å“åº”å¼ï¼ˆæ¨èç”¨ reactiveï¼‰
const state = reactive({
  count: 0,
  user: { name: 'Vue' },
  list: [1, 2, 3]
})

// 4. ç»„åˆä½¿ç”¨
const state2 = reactive({
  count: ref(0),        // åœ¨ reactive ä¸­ä½¿ç”¨ ref
  user: { name: 'Vue' }
})

// è®¿é—®æ—¶è‡ªåŠ¨è§£åŒ…
console.log(state2.count) // 0ï¼Œä¸éœ€è¦ .value
```


### é—®é¢˜6ï¼šcomputedæ˜¯å¦‚ä½•å®ç°æ‡’è®¡ç®—å’Œç¼“å­˜çš„ï¼Ÿ
**å­¦ä¹ é‡ç‚¹ï¼š**
- computedçš„ç¼“å­˜æœºåˆ¶
- æ‡’è®¡ç®—çš„å®ç°åŸç†
- computedå’Œeffectçš„å…³ç³»

**å®è·µä»»åŠ¡ï¼š**
```javascript
// å®ç°computed
function computed(getter) {
  // æ€è€ƒï¼šå¦‚ä½•å®ç°ç¼“å­˜ï¼Ÿ
  /**
   * computed()æ‰§è¡Œä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡æœ‰ä¸€ä¸ªå±æ€§æ˜¯dirty
   * dirtyè¡¨ç¤ºæ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—
   * å¦‚æœdirtyä¸ºtrueï¼Œåˆ™éœ€è¦é‡æ–°è®¡ç®—ï¼Œå¦åˆ™è¿”å›ç¼“å­˜çš„å€¼
   * å¦‚æœæ²¡æœ‰ä¾èµ–å˜åŒ–dirtyåˆ™ä¸ºfalseï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—
   */
  // æ€è€ƒï¼šä½•æ—¶é‡æ–°è®¡ç®—ï¼Ÿ
  /**
   * computedçš„ä¾èµ–é¡¹å‘ç”Ÿæ”¹å˜æ—¶
   */
  // æ€è€ƒï¼šcomputedæœ¬èº«ä¹Ÿæ˜¯å“åº”å¼çš„ï¼Œå¦‚ä½•å®ç°ï¼Ÿ
  /**
   * computedåœ¨getçš„æ—¶å€™ä¹Ÿä¼šæ”¶é›†ä¾èµ–ï¼Œå½“computedçš„ä¾èµ–é¡¹å˜åŒ–æ—¶ï¼Œ
   * ä¼šè§¦å‘scheduleré€šçŸ¥ä¾èµ–äºcomputedçš„effecté‡æ–°æ‰§è¡Œ
   * è¿™äº›effectè°ƒç”¨æ—¶å°±ä¼šè®¿é—®åˆ°computedçš„å€¼ä»è€Œé‡æ–°è®¡ç®—
   */
}

const state = reactive({ firstName: 'John', lastName: 'Doe' })
const fullName = computed(() => {
  console.log('è®¡ç®—fullName') // åº”è¯¥åªåœ¨ä¾èµ–å˜åŒ–æ—¶æ‰§è¡Œ
  return `${state.firstName} ${state.lastName}`
})
```
**ç­”æ¡ˆï¼š**

#### computed çš„å®Œæ•´å®ç°

```javascript
export function computed(getterOrOptions) {
  let getter, setter
  
  if (isFunction(getterOrOptions)) {
    getter = getterOrOptions
    setter = () => {
      console.warn('Computed property is readonly')
    }
  } else {
    getter = getterOrOptions.get
    setter = getterOrOptions.set
  }
  
  return new ComputedRefImpl(getter, setter)
}

class ComputedRefImpl {
  constructor(getter, setter) {
    this._setter = setter
    this._dirty = true    // è„æ ‡è®°ï¼šæ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—
    this._value = undefined // ç¼“å­˜çš„è®¡ç®—ç»“æœ
    
    // åˆ›å»ºå†…éƒ¨ effectï¼Œè®¾ç½®ä¸ºæ‡’æ‰§è¡Œ
    this.effect = effect(getter, {
      lazy: true,  // æ‡’æ‰§è¡Œï¼šä¸ç«‹å³æ‰§è¡Œ
      scheduler: () => {
        // ä¾èµ–å˜åŒ–æ—¶çš„è°ƒåº¦å™¨
        if (!this._dirty) {
          this._dirty = true
          // é€šçŸ¥ä¾èµ–å½“å‰ computed çš„ effect
          trigger(this, 'value')
        }
      }
    })
  }
  
  get value() {
    // 1. ä¾èµ–æ”¶é›†ï¼šæ”¶é›†ä¾èµ–å½“å‰ computed çš„ effect
    track(this, 'value')
    
    // 2. æ‡’è®¡ç®—ï¼šåªæœ‰è„äº†æ‰é‡æ–°è®¡ç®—
    if (this._dirty) {
      this._value = this.effect() // æ‰§è¡Œ getter
      this._dirty = false         // é‡ç½®è„æ ‡è®°
    }
    
    // 3. è¿”å›ç¼“å­˜å€¼
    return this._value
  }
  
  set value(newValue) {
    this._setter(newValue)
  }
}
```

#### ç¼“å­˜æœºåˆ¶è¯¦è§£

**1. è„æ ‡è®°ï¼ˆdirty flagï¼‰**
```javascript
// åˆå§‹çŠ¶æ€ï¼š_dirty = trueï¼Œéœ€è¦è®¡ç®—
const fullName = computed(() => {
  console.log('è®¡ç®—æ‰§è¡Œ') // åªåœ¨éœ€è¦æ—¶æ‰“å°
  return `${firstName.value} ${lastName.value}`
})

// ç¬¬ä¸€æ¬¡è®¿é—®ï¼š_dirty = true â†’ æ‰§è¡Œè®¡ç®— â†’ _dirty = false
console.log(fullName.value) // "è®¡ç®—æ‰§è¡Œ" + "John Doe"

// ç¬¬äºŒæ¬¡è®¿é—®ï¼š_dirty = false â†’ ç›´æ¥è¿”å›ç¼“å­˜
console.log(fullName.value) // ç›´æ¥è¿”å› "John Doe"ï¼Œä¸æ‰“å°"è®¡ç®—æ‰§è¡Œ"

// ä¾èµ–å˜åŒ–ï¼šfirstName æ”¹å˜ â†’ scheduler æ‰§è¡Œ â†’ _dirty = true
firstName.value = 'Jane'

// å†æ¬¡è®¿é—®ï¼š_dirty = true â†’ é‡æ–°è®¡ç®— â†’ _dirty = false
console.log(fullName.value) // "è®¡ç®—æ‰§è¡Œ" + "Jane Doe"
```

#### æ‡’è®¡ç®—å®ç°åŸç†

**1. lazy effect**
```javascript
// æ™®é€š effectï¼šç«‹å³æ‰§è¡Œ
effect(() => {
  console.log('ç«‹å³æ‰§è¡Œ')
}) // é©¬ä¸Šæ‰“å° "ç«‹å³æ‰§è¡Œ"

// æ‡’ effectï¼šä¸ç«‹å³æ‰§è¡Œ
const lazyEffect = effect(() => {
  console.log('æ‡’æ‰§è¡Œ')
}, { lazy: true })

// æ‰‹åŠ¨æ‰§è¡Œæ‰ä¼šè¿è¡Œ
lazyEffect() // ç°åœ¨æ‰æ‰“å° "æ‡’æ‰§è¡Œ"
```

**2. computed çš„æ‡’ç‰¹æ€§**
```javascript
// åˆ›å»º computed æ—¶ä¸ä¼šæ‰§è¡Œ getter
const expensiveComputed = computed(() => {
  console.log('æ˜‚è´µçš„è®¡ç®—') // åˆ›å»ºæ—¶ä¸ä¼šæ‰“å°
  return heavyCalculation()
})

// åªæœ‰è®¿é—®æ—¶æ‰æ‰§è¡Œ
console.log(expensiveComputed.value) // ç°åœ¨æ‰æ‰“å°å¹¶è®¡ç®—
```

#### computed ä¸ effect çš„å…³ç³»

**1. computed å†…éƒ¨ä½¿ç”¨ effect**
```javascript
// computed æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ effect
const computed = (getter) => {
  const effectFn = effect(getter, { lazy: true })
  return {
    get value() {
      return effectFn() // æ‰§è¡Œ effect è·å–æœ€æ–°å€¼
    }
  }
}
```

**2. åŒé‡èº«ä»½**
```javascript
const firstName = ref('John')
const lastName = ref('Doe')

const fullName = computed(() => {
  return `${firstName.value} ${lastName.value}`
})

// fullName æ—¢æ˜¯ effectï¼ˆä¾èµ– firstName å’Œ lastNameï¼‰
// ä¹Ÿæ˜¯å“åº”å¼æ•°æ®ï¼ˆå¯ä»¥è¢«å…¶ä»– effect ä¾èµ–ï¼‰
effect(() => {
  console.log('Full name is:', fullName.value)
})
```

#### å®Œæ•´çš„æ‰§è¡Œæµç¨‹

```javascript
// 1. åˆ›å»ºé˜¶æ®µ
const count = ref(0)
const doubled = computed(() => count.value * 2)

// 2. é¦–æ¬¡è®¿é—®
effect(() => {
  console.log(doubled.value) // è§¦å‘è®¡ç®—é“¾
})

// æµç¨‹ï¼š
// effect æ‰§è¡Œ â†’ è®¿é—® doubled.value â†’ track(doubled, 'value')
// â†’ doubled._dirty = true â†’ æ‰§è¡Œ doubled.effect()
// â†’ è®¿é—® count.value â†’ track(count, 'value')
// â†’ è¿”å›è®¡ç®—ç»“æœ â†’ doubled._dirty = false

// 3. ä¾èµ–æ›´æ–°
count.value = 1

// æµç¨‹ï¼š
// count å˜åŒ– â†’ trigger(count, 'value') â†’ doubled.scheduler æ‰§è¡Œ
// â†’ doubled._dirty = true â†’ trigger(doubled, 'value')
// â†’ ä¾èµ– doubled çš„ effect é‡æ–°æ‰§è¡Œ â†’ è®¿é—® doubled.value
// â†’ é‡æ–°è®¡ç®— â†’ è¿”å›æ–°ç»“æœ
```

#### æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

**1. é¿å…ä¸å¿…è¦çš„è®¡ç®—**
```javascript
// âœ… å¥½çš„åšæ³•ï¼šcomputed ä¼šç¼“å­˜ç»“æœ
const expensiveValue = computed(() => {
  return items.value.filter(item => item.active)
                   .map(item => heavyTransform(item))
})

// âŒ ä¸å¥½çš„åšæ³•ï¼šæ¯æ¬¡éƒ½é‡æ–°è®¡ç®—
const getExpensiveValue = () => {
  return items.value.filter(item => item.active)
                   .map(item => heavyTransform(item))
}
```

**2. åˆç†çš„ä¾èµ–ç²’åº¦**
```javascript
// âœ… ç»†ç²’åº¦ä¾èµ–ï¼šåªæœ‰ç›¸å…³å­—æ®µå˜åŒ–æ‰é‡æ–°è®¡ç®—
const fullName = computed(() => {
  return `${user.value.firstName} ${user.value.lastName}`
})

// âŒ ç²—ç²’åº¦ä¾èµ–ï¼šæ•´ä¸ª user å¯¹è±¡å˜åŒ–éƒ½ä¼šé‡æ–°è®¡ç®—
const fullName = computed(() => {
  const u = user.value
  return `${u.firstName} ${u.lastName}`
})
```

[computedçš„æ‰§è¡Œè¿‡ç¨‹](./æµç¨‹å›¾/computed-flow-diagram.md)

## ğŸ“– ç†è®ºå­¦ä¹ èµ„æº

### Vue 3å®˜æ–¹æ–‡æ¡£
- [å“åº”å¼åŸºç¡€](https://cn.vuejs.org/guide/essentials/reactivity-fundamentals.html)
- [æ·±å…¥å“åº”å¼ç³»ç»Ÿ](https://cn.vuejs.org/guide/extras/reactivity-in-depth.html)

### æºç å¯¹åº”ä½ç½®
core/packages/reactivity/src

### å…³é”®æ¦‚å¿µæ¢³ç†
1. **å“åº”å¼å¯¹è±¡** - é€šè¿‡Proxyåˆ›å»ºçš„èƒ½å¤Ÿè‡ªåŠ¨è¿½è¸ªå˜åŒ–çš„å¯¹è±¡
2. **å‰¯ä½œç”¨å‡½æ•°** - ä¼šäº§ç”Ÿå‰¯ä½œç”¨çš„å‡½æ•°ï¼Œéœ€è¦åœ¨æ•°æ®å˜åŒ–æ—¶é‡æ–°æ‰§è¡Œ
3. **ä¾èµ–æ”¶é›†** - åœ¨å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶æ”¶é›†å…¶ä¾èµ–çš„å“åº”å¼æ•°æ®
4. **æ´¾å‘æ›´æ–°** - å½“å“åº”å¼æ•°æ®å˜åŒ–æ—¶ï¼Œé€šçŸ¥æ‰€æœ‰ä¾èµ–å®ƒçš„å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œ

## ğŸ› ï¸ å®è·µä»»åŠ¡æ¸…å•

- [âœ…] å®ç°åŸºç¡€çš„reactiveå‡½æ•°
- [âœ…] å®ç°effectå‡½æ•°å’Œä¾èµ–æ”¶é›†
- [âœ…] å®ç°triggerå‡½æ•°å’Œæ´¾å‘æ›´æ–°
- [âœ…] å¤„ç†æ•°ç»„çš„å“åº”å¼
- [âœ…] å®ç°refå‡½æ•°
- [âœ…] å®ç°computedå‡½æ•°
- [âœ…] å¤„ç†è¾¹ç•Œæƒ…å†µï¼ˆå¾ªç¯ä¾èµ–ã€åµŒå¥—effectç­‰ï¼‰
- [âœ…] ç¼–å†™æµ‹è¯•ç”¨ä¾‹éªŒè¯å®ç°æ­£ç¡®æ€§

## ğŸ”¬ æºç ç ”è¯»é‡ç‚¹

### 1. reactive.tsä¸­çš„createReactiveObjectå‡½æ•°
```typescript
// æ€è€ƒé—®é¢˜ï¼š
// 1. ä¸ºä»€ä¹ˆéœ€è¦ä¸åŒçš„æ‹¦æˆªå™¨ï¼Ÿ
// 2. å¦‚ä½•å¤„ç†å·²ç»æ˜¯å“åº”å¼çš„å¯¹è±¡ï¼Ÿ
// 3. å¦‚ä½•å¤„ç†ä¸å¯ä»£ç†çš„å¯¹è±¡ï¼Ÿ
```

**ç­”æ¡ˆï¼š**

#### 1. ä¸ºä»€ä¹ˆéœ€è¦ä¸åŒçš„æ‹¦æˆªå™¨ï¼ˆhandlersï¼‰ï¼Ÿ

**ç­”æ¡ˆï¼š** ä¸åŒç±»å‹çš„å¯¹è±¡æœ‰ä¸åŒçš„å†…éƒ¨ç»“æ„å’Œæ“ä½œè¯­ä¹‰ï¼Œéœ€è¦ä¸“é—¨çš„å¤„ç†ç­–ç•¥ï¼š

```javascript
// æ™®é€šå¯¹è±¡å¤„ç†å™¨
const baseHandlers = {
  get(target, key, receiver) {
    // å¤„ç†æ™®é€šå±æ€§è®¿é—®
    const res = Reflect.get(target, key, receiver)
    track(target, key)
    return isObject(res) ? reactive(res) : res
  },
  set(target, key, value, receiver) {
    const oldValue = target[key]
    const result = Reflect.set(target, key, value, receiver)
    if (hasChanged(value, oldValue)) {
      trigger(target, key)
    }
    return result
  }
}

// æ•°ç»„ç‰¹æ®Šå¤„ç†å™¨
const arrayHandlers = {
  ...baseHandlers,
  get(target, key, receiver) {
    // æ•°ç»„æ–¹æ³•çš„ç‰¹æ®Šå¤„ç†
    if (arrayInstrumentations.hasOwnProperty(key)) {
      return Reflect.get(arrayInstrumentations, key, receiver)
    }
    return baseHandlers.get(target, key, receiver)
  }
}

// é›†åˆç±»å‹å¤„ç†å™¨ï¼ˆMapã€Setã€WeakMapã€WeakSetï¼‰
const collectionHandlers = {
  get(target, key, receiver) {
    // é›†åˆæ–¹æ³•éœ€è¦ç‰¹æ®Šç»‘å®š this
    if (key === 'size') {
      track(target, 'iterate')
      return Reflect.get(target, key, target)
    }
    return getCollectionMethod(key, target)
  }
}
```

**ä¸ºä»€ä¹ˆéœ€è¦åŒºåˆ†ï¼Ÿ**
1. **æ•°ç»„**ï¼šéœ€è¦ç‰¹æ®Šå¤„ç† `push`ã€`pop`ã€`shift`ã€`unshift`ã€`splice` ç­‰æ–¹æ³•
2. **Map/Set**ï¼šéœ€è¦å¤„ç† `size` å±æ€§å’Œè¿­ä»£å™¨æ–¹æ³•
3. **æ™®é€šå¯¹è±¡**ï¼šæ ‡å‡†çš„å±æ€§è®¿é—®å’Œè®¾ç½®

#### 2. å¦‚ä½•å¤„ç†å·²ç»æ˜¯å“åº”å¼çš„å¯¹è±¡ï¼Ÿ

**ç­”æ¡ˆï¼š** é€šè¿‡ `reactiveMap` ç¼“å­˜æœºåˆ¶é¿å…é‡å¤ä»£ç†ï¼š

```javascript
// å…¨å±€ç¼“å­˜æ˜ å°„
const reactiveMap = new WeakMap()
const readonlyMap = new WeakMap()

export function reactive(target) {
  // 1. åŸºæœ¬ç±»å‹æ£€æŸ¥
  if (!isObject(target)) {
    return target
  }
  
  // 2. æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å“åº”å¼å¯¹è±¡
  if (target[ReactiveFlags.IS_REACTIVE]) {
    return target
  }
  
  // 3. æ£€æŸ¥ç¼“å­˜
  const existingProxy = reactiveMap.get(target)
  if (existingProxy) {
    return existingProxy
  }
  
  // 4. åˆ›å»ºæ–°çš„å“åº”å¼å¯¹è±¡
  const proxy = new Proxy(target, baseHandlers)
  
  // 5. ç¼“å­˜ç»“æœ
  reactiveMap.set(target, proxy)
  
  return proxy
}
```

**ç¼“å­˜çš„å¥½å¤„ï¼š**
1. **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…é‡å¤åˆ›å»º Proxy
2. **å¼•ç”¨ä¸€è‡´æ€§**ï¼šåŒä¸€ä¸ªå¯¹è±¡æ€»æ˜¯è¿”å›åŒä¸€ä¸ªä»£ç†
3. **å†…å­˜ä¼˜åŒ–**ï¼šä½¿ç”¨ WeakMap è‡ªåŠ¨åƒåœ¾å›æ”¶

```javascript
// ç¤ºä¾‹ï¼šå¼•ç”¨ä¸€è‡´æ€§
const obj = { count: 0 }
const reactive1 = reactive(obj)
const reactive2 = reactive(obj)

console.log(reactive1 === reactive2) // trueï¼Œè¿”å›åŒä¸€ä¸ªä»£ç†
```

#### 3. å¦‚ä½•å¤„ç†ä¸å¯ä»£ç†çš„å¯¹è±¡ï¼Ÿ

**ç­”æ¡ˆï¼š** é€šè¿‡å¤šå±‚æ£€æŸ¥ç¡®ä¿åªæœ‰åˆé€‚çš„å¯¹è±¡æ‰è¢«ä»£ç†ï¼š

```javascript
// ä¸å¯ä»£ç†å¯¹è±¡çš„åˆ¤æ–­
function canObserve(value) {
  return (
    !value[ReactiveFlags.SKIP] &&           // æ²¡æœ‰è·³è¿‡æ ‡è®°
    isObservableType(toRawType(value)) &&    // æ˜¯å¯è§‚å¯Ÿç±»å‹
    !Object.isFrozen(value)                  // æ²¡æœ‰è¢«å†»ç»“
  )
}

// å¯è§‚å¯Ÿç±»å‹æ£€æŸ¥
const isObservableType = makeMap(
  'Object,Array,Map,Set,WeakMap,WeakSet'
)

// è·å–å¯¹è±¡çš„åŸå§‹ç±»å‹
function toRawType(value) {
  return Object.prototype.toString.call(value).slice(8, -1)
}

export function reactive(target) {
  // åŸºæœ¬ç±»å‹ç›´æ¥è¿”å›
  if (!isObject(target)) {
    if (__DEV__) {
      console.warn(`value cannot be made reactive: ${String(target)}`)
    }
    return target
  }
  
  // ä¸å¯è§‚å¯Ÿå¯¹è±¡ç›´æ¥è¿”å›
  if (!canObserve(target)) {
    return target
  }
  
  // å…¶ä»–å¤„ç†é€»è¾‘...
}
```

**ä¸å¯ä»£ç†çš„æƒ…å†µï¼š**
1. **åŸºæœ¬ç±»å‹**ï¼š`string`ã€`number`ã€`boolean`ã€`null`ã€`undefined`
2. **ç‰¹æ®Šå¯¹è±¡**ï¼š`Date`ã€`RegExp`ã€`Promise` ç­‰
3. **å†»ç»“å¯¹è±¡**ï¼š`Object.freeze()` å¤„ç†è¿‡çš„å¯¹è±¡
4. **æ ‡è®°è·³è¿‡**ï¼šå¸¦æœ‰ `__v_skip` æ ‡è®°çš„å¯¹è±¡

```javascript
// ç¤ºä¾‹ï¼šå„ç§ä¸å¯ä»£ç†æƒ…å†µ
reactive(42)                    // è¿”å› 42
reactive('hello')               // è¿”å› 'hello'
reactive(new Date())            // è¿”å›åŸ Date å¯¹è±¡
reactive(Object.freeze({}))     // è¿”å›åŸå†»ç»“å¯¹è±¡

// æ‰‹åŠ¨æ ‡è®°è·³è¿‡
const skipObj = { __v_skip: true, data: 'test' }
reactive(skipObj)               // è¿”å›åŸå¯¹è±¡
```



### 2. effect.tsä¸­çš„ReactiveEffectç±»
```typescript
// æ€è€ƒé—®é¢˜ï¼š
// 1. ä¸ºä»€ä¹ˆéœ€è¦effectæ ˆï¼Ÿ
// 2. å¦‚ä½•å¤„ç†effectçš„åœæ­¢å’Œæ¢å¤ï¼Ÿ
// 3. schedulerçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
```

**ç­”æ¡ˆï¼š**

#### 1. effectæ ˆçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**ç­”æ¡ˆï¼š** effect æ ˆè§£å†³äº†åµŒå¥— effect æ‰§è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ç®¡ç†é—®é¢˜ï¼š

```javascript
let activeEffect = null
const effectStack = []

function effect(fn, options = {}) {
  const effectFn = () => {
    cleanup(effectFn)
    
    try {
      // å…¥æ ˆï¼šä¿å­˜å½“å‰ activeEffect
      effectStack.push(activeEffect)
      activeEffect = effectFn
      
      // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
      return fn()
    } finally {
      // å‡ºæ ˆï¼šæ¢å¤ä¸Šä¸€ä¸ª activeEffect
      effectStack.pop()
      activeEffect = effectStack[effectStack.length - 1]
    }
  }
  
  effectFn.deps = []
  effectFn()
  return effectFn
}
```

**åµŒå¥— effect çš„é—®é¢˜ç¤ºä¾‹ï¼š**
```javascript
// æ²¡æœ‰æ ˆç®¡ç†çš„é—®é¢˜
effect(() => {
  console.log('å¤–å±‚ effect')
  
  effect(() => {
    console.log('å†…å±‚ effect')
    // è¿™é‡Œ activeEffect è¢«å†…å±‚è¦†ç›–
  })
  
  // è¿™é‡Œ activeEffect åº”è¯¥æ¢å¤ä¸ºå¤–å±‚ï¼Œä½†æ²¡æœ‰æ ˆå°±ä¼šä¸¢å¤±
  console.log('å¤–å±‚ effect ç»§ç»­')
})

// æœ‰æ ˆç®¡ç†çš„æ­£ç¡®æµç¨‹
// 1. activeEffect = null, stack = []
// 2. å¤–å±‚ effect å¼€å§‹: activeEffect = outerEffect, stack = [null]
// 3. å†…å±‚ effect å¼€å§‹: activeEffect = innerEffect, stack = [null, outerEffect]
// 4. å†…å±‚ effect ç»“æŸ: activeEffect = outerEffect, stack = [null]
// 5. å¤–å±‚ effect ç»“æŸ: activeEffect = null, stack = []
```

#### 2. å¦‚ä½•åœæ­¢å’Œæ¢å¤effectï¼Ÿ

**ç­”æ¡ˆï¼š** é€šè¿‡ `stop` æ–¹æ³•å’Œé‡æ–°æ‰§è¡Œå®ç° effect çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š

```javascript
function effect(fn, options = {}) {
  const effectFn = () => {
    // å¦‚æœå·²åœæ­¢ï¼Œä¸æ‰§è¡Œ
    if (!effectFn.active) return
    
    cleanup(effectFn)
    
    try {
      effectStack.push(activeEffect)
      activeEffect = effectFn
      return fn()
    } finally {
      effectStack.pop()
      activeEffect = effectStack[effectStack.length - 1]
    }
  }
  
  effectFn.deps = []
  effectFn.active = true  // æ´»è·ƒçŠ¶æ€æ ‡è®°
  
  // åœæ­¢æ–¹æ³•
  effectFn.stop = () => {
    if (effectFn.active) {
      cleanup(effectFn)     // æ¸…ç†æ‰€æœ‰ä¾èµ–
      effectFn.active = false
      if (options.onStop) {
        options.onStop()    // åœæ­¢å›è°ƒ
      }
    }
  }
  
  if (!options.lazy) {
    effectFn()
  }
  
  return effectFn
}

// cleanup å‡½æ•°ï¼šæ¸…ç†ä¾èµ–å…³ç³»
function cleanup(effectFn) {
  const { deps } = effectFn
  if (deps.length) {
    for (let i = 0; i < deps.length; i++) {
      deps[i].delete(effectFn)  // ä»ä¾èµ–é›†åˆä¸­ç§»é™¤
    }
    deps.length = 0             // æ¸…ç©ºä¾èµ–æ•°ç»„
  }
}
```

#### 3. schedulerçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**ç­”æ¡ˆï¼š** scheduler æä¾›äº†è‡ªå®šä¹‰ effect æ‰§è¡Œæ—¶æœºçš„èƒ½åŠ›ï¼Œå®ç°å¼‚æ­¥æ›´æ–°ã€æ‰¹é‡æ›´æ–°ç­‰é«˜çº§åŠŸèƒ½ï¼š

```javascript
function effect(fn, options = {}) {
  const effectFn = () => {
    // æ­£å¸¸æ‰§è¡Œé€»è¾‘...
  }
  
  effectFn.scheduler = options.scheduler
  
  // å…¶ä»–é€»è¾‘...
}

// trigger ä¸­ä½¿ç”¨ scheduler
function trigger(target, key) {
  const deps = targetMap.get(target)
  if (!deps) return
  
  const effects = deps.get(key)
  if (!effects) return
  
  const effectsToRun = new Set(effects)
  
  effectsToRun.forEach(effectFn => {
    if (effectFn.scheduler) {
      // ä½¿ç”¨è‡ªå®šä¹‰è°ƒåº¦å™¨
      effectFn.scheduler(effectFn)
    } else {
      // ç›´æ¥æ‰§è¡Œ
      effectFn()
    }
  })
}
```

**å¸¸è§çš„ scheduler åº”ç”¨ï¼š**

**1. å¼‚æ­¥æ›´æ–°ï¼ˆå¾®ä»»åŠ¡ï¼‰**
```javascript
effect(() => {
  console.log('å¼‚æ­¥æ›´æ–°:', state.count)
}, {
  scheduler: (effect) => {
    Promise.resolve().then(() => effect())
  }
})

state.count = 1
state.count = 2
state.count = 3
// åªä¼šåœ¨å¾®ä»»åŠ¡ä¸­æ‰§è¡Œä¸€æ¬¡ï¼Œè¾“å‡º: "å¼‚æ­¥æ›´æ–°: 3"
```

**2. æ‰¹é‡æ›´æ–°**
```javascript
const queue = new Set()
let isFlushing = false

function queueJob(job) {
  queue.add(job)
  if (!isFlushing) {
    isFlushing = true
    Promise.resolve().then(() => {
      queue.forEach(job => job())
      queue.clear()
      isFlushing = false
    })
  }
}

effect(() => {
  console.log('æ‰¹é‡æ›´æ–°:', state.count)
}, {
  scheduler: queueJob
})

// åŒæ­¥ä¿®æ”¹å¤šæ¬¡ï¼Œåªæ‰§è¡Œä¸€æ¬¡æ›´æ–°
state.count = 1
state.count = 2
state.count = 3
// è¾“å‡º: "æ‰¹é‡æ›´æ–°: 3"
```


### 3. baseHandlers.tsä¸­çš„getå’Œsetæ‹¦æˆªå™¨
```typescript
// æ€è€ƒé—®é¢˜ï¼š
// 1. å¦‚ä½•å¤„ç†æ·±å±‚åµŒå¥—çš„å¯¹è±¡ï¼Ÿ
// 2. å¦‚ä½•å¤„ç†æ•°ç»„çš„ç‰¹æ®Šç´¢å¼•ï¼Ÿ
// 3. å¦‚ä½•é¿å…ä¸å¿…è¦çš„ä¾èµ–æ”¶é›†ï¼Ÿ
```

**ç­”æ¡ˆï¼š**

#### 1. å¦‚ä½•å¤„ç†æ·±å±‚åµŒå¥—å¯¹è±¡ï¼Ÿ

**ç­”æ¡ˆï¼š** é€šè¿‡åœ¨ `get` æ‹¦æˆªå™¨ä¸­é€’å½’è½¬æ¢å®ç°æ·±å±‚å“åº”å¼ï¼š

```javascript
const baseHandlers = {
  get(target, key, receiver) {
    // 1. å¤„ç†ç‰¹æ®Šå±æ€§
    if (key === ReactiveFlags.IS_REACTIVE) {
      return true
    }
    if (key === ReactiveFlags.RAW) {
      return target
    }
    
    // 2. ä¾èµ–æ”¶é›†
    track(target, key)
    
    // 3. è·å–åŸå§‹å€¼
    const res = Reflect.get(target, key, receiver)
    
    // 4. å¤„ç† ref è‡ªåŠ¨è§£åŒ…
    if (isRef(res)) {
      return res.value
    }
    
    // 5. æ·±å±‚å“åº”å¼è½¬æ¢
    if (isObject(res)) {
      return reactive(res)  // é€’å½’è½¬æ¢åµŒå¥—å¯¹è±¡
    }
    
    return res
  },
  
  set(target, key, value, receiver) {
    const oldValue = target[key]
    
    // å¤„ç† ref çš„ç‰¹æ®Šè®¾ç½®
    if (isRef(oldValue) && !isRef(value)) {
      oldValue.value = value
      return true
    }
    
    const result = Reflect.set(target, key, value, receiver)
    
    // åªæœ‰å€¼çœŸæ­£æ”¹å˜æ—¶æ‰è§¦å‘æ›´æ–°
    if (hasChanged(value, oldValue)) {
      trigger(target, key)
    }
    
    return result
  }
}
```

**æ·±å±‚å“åº”å¼ç¤ºä¾‹ï¼š**
```javascript
const state = reactive({
  user: {
    profile: {
      name: 'Vue',
      settings: {
        theme: 'dark'
      }
    }
  }
})

// è®¿é—®æ·±å±‚å±æ€§æ—¶è‡ªåŠ¨è½¬æ¢ä¸ºå“åº”å¼
effect(() => {
  // state.user â†’ reactive(user)
  // state.user.profile â†’ reactive(profile)
  // state.user.profile.settings â†’ reactive(settings)
  console.log(state.user.profile.settings.theme)
})

// æ·±å±‚ä¿®æ”¹ä¹Ÿèƒ½è§¦å‘æ›´æ–°
state.user.profile.settings.theme = 'light'  // è§¦å‘ effect
```

#### 2. å¦‚ä½•å¤„ç†æ•°ç»„çš„ç‰¹æ®Šç´¢å¼•ï¼Ÿ

**ç­”æ¡ˆï¼š** æ•°ç»„éœ€è¦ç‰¹æ®Šå¤„ç†ç´¢å¼•è®¿é—®ã€é•¿åº¦å˜åŒ–å’Œæ•°ç»„æ–¹æ³•ï¼š

```javascript
// æ•°ç»„æ–¹æ³•çš„ç‰¹æ®Šå¤„ç†
const arrayInstrumentations = {}

// éœ€è¦ç‰¹æ®Šå¤„ç†çš„æ•°ç»„æ–¹æ³•
;['push', 'pop', 'shift', 'unshift', 'splice'].forEach(key => {
  const originalMethod = Array.prototype[key]
  arrayInstrumentations[key] = function(...args) {
    // æš‚åœä¾èµ–æ”¶é›†ï¼Œé¿å…åœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æ”¶é›†ä¸å¿…è¦çš„ä¾èµ–
    pauseTracking()
    const result = originalMethod.apply(this, args)
    resetTracking()
    return result
  }
})

const arrayHandlers = {
  get(target, key, receiver) {
    // 1. å¤„ç†æ•°ç»„æ–¹æ³•
    if (arrayInstrumentations.hasOwnProperty(key)) {
      return Reflect.get(arrayInstrumentations, key, receiver)
    }
    
    // 2. å¤„ç†æ•°ç»„ç´¢å¼•å’Œé•¿åº¦
    if (typeof key === 'string' && /^\d+$/.test(key)) {
      // æ•°å­—å­—ç¬¦ä¸²ç´¢å¼•
      track(target, key)
    } else if (key === 'length') {
      // é•¿åº¦å±æ€§
      track(target, 'length')
    }
    
    return baseHandlers.get(target, key, receiver)
  },
  
  set(target, key, value, receiver) {
    const oldValue = target[key]
    const oldLength = target.length
    
    const result = Reflect.set(target, key, value, receiver)
    
    // å¤„ç†æ•°ç»„é•¿åº¦å˜åŒ–
    if (key === 'length' && value < oldLength) {
      // æ•°ç»„è¢«æˆªæ–­ï¼Œè§¦å‘è¢«åˆ é™¤å…ƒç´ çš„ä¾èµ–
      for (let i = value; i < oldLength; i++) {
        trigger(target, String(i))
      }
    } else if (typeof key === 'string' && /^\d+$/.test(key)) {
      // æ•°ç»„ç´¢å¼•å˜åŒ–
      const index = Number(key)
      if (index >= oldLength) {
        // æ–°å¢å…ƒç´ ï¼Œè§¦å‘ length ä¾èµ–
        trigger(target, 'length')
      }
    }
    
    if (hasChanged(value, oldValue)) {
      trigger(target, key)
    }
    
    return result
  }
}
```

#### 3. å¦‚ä½•é¿å…ä¸å¿…è¦çš„ä¾èµ–æ”¶é›†ï¼Ÿ

**ç­”æ¡ˆï¼š** é€šè¿‡å¤šç§ç­–ç•¥è¿‡æ»¤ä¸éœ€è¦è¿½è¸ªçš„å±æ€§è®¿é—®ï¼š

```javascript
// ä¸éœ€è¦è¿½è¸ªçš„ key ç±»å‹
const isNonTrackableKeys = makeMap(`__proto__,__v_isRef,__isVue`)

// Symbol ç±»å‹çš„å†…ç½® key
const builtInSymbols = new Set(
  Object.getOwnPropertyNames(Symbol)
    .map(key => Symbol[key])
    .filter(isSymbol)
)

function get(target, key, receiver) {
  // 1. è·³è¿‡ç‰¹æ®Šå±æ€§
  if (key === ReactiveFlags.IS_REACTIVE) {
    return true
  }
  if (key === ReactiveFlags.RAW) {
    return target
  }
  
  // 2. è·³è¿‡ä¸å¯è¿½è¸ªçš„ key
  if (isNonTrackableKeys(key)) {
    return Reflect.get(target, key, receiver)
  }
  
  // 3. è·³è¿‡å†…ç½® Symbol
  if (isSymbol(key) && builtInSymbols.has(key)) {
    return Reflect.get(target, key, receiver)
  }
  
  const res = Reflect.get(target, key, receiver)
  
  // 4. åªæœ‰åœ¨æœ‰ activeEffect æ—¶æ‰æ”¶é›†ä¾èµ–
  if (activeEffect) {
    track(target, key)
  }
  
  return isObject(res) ? reactive(res) : res
}

// è¿½è¸ªæ§åˆ¶
let shouldTrack = true
const trackStack = []

export function pauseTracking() {
  trackStack.push(shouldTrack)
  shouldTrack = false
}

export function resetTracking() {
  const last = trackStack.pop()
  shouldTrack = last === undefined ? true : last
}

function track(target, key) {
  // åªæœ‰åœ¨å…è®¸è¿½è¸ªä¸”æœ‰æ´»è·ƒ effect æ—¶æ‰æ”¶é›†ä¾èµ–
  if (!shouldTrack || !activeEffect) {
    return
  }
  
  // ä¾èµ–æ”¶é›†é€»è¾‘...
}
```

## âœ… å­¦ä¹ æˆæœæ£€éªŒ

å®Œæˆæœ¬é˜¶æ®µå­¦ä¹ åï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

1. **ç†è®ºç†è§£**
   - [ ] æ¸…æ¥šè§£é‡Šä»€ä¹ˆæ˜¯å“åº”å¼ä»¥åŠVue 3å“åº”å¼çš„ä¼˜åŠ¿
   - [ ] ç†è§£Proxyç›¸æ¯”Object.definePropertyçš„ä¼˜åŠ¿
   - [ ] æŒæ¡ä¾èµ–æ”¶é›†å’Œæ´¾å‘æ›´æ–°çš„å®Œæ•´æµç¨‹

2. **å®è·µèƒ½åŠ›**
   - [ ] ç‹¬ç«‹å®ç°ä¸€ä¸ªåŸºç¡€çš„å“åº”å¼ç³»ç»Ÿ
   - [ ] å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸åœºæ™¯
   - [ ] ç¼–å†™å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹

3. **æºç ç†è§£**
   - [ ] èƒ½å¤Ÿé˜…è¯»Vue 3å“åº”å¼ç›¸å…³æºç 
   - [ ] ç†è§£æºç ä¸­çš„è®¾è®¡æ€è·¯å’Œå®ç°ç»†èŠ‚
   - [ ] èƒ½å¤Ÿè§£é‡Šæºç ä¸­çš„å…³é”®å‡½æ•°ä½œç”¨

## ğŸ¯ è¿›é˜¶æ€è€ƒé¢˜

1. ä¸ºä»€ä¹ˆVue 3é€‰æ‹©Proxyè€Œä¸æ˜¯ç»§ç»­ä½¿ç”¨Object.definePropertyï¼Ÿ
2. ä¾èµ–æ”¶é›†çš„æ•°æ®ç»“æ„ä¸ºä»€ä¹ˆè®¾è®¡æˆtarget -> key -> effectsçš„æ˜ å°„ï¼Ÿ
3. effectåµŒå¥—æ—¶å¦‚ä½•æ­£ç¡®æ”¶é›†ä¾èµ–ï¼Ÿ
4. å¦‚ä½•å¤„ç†Setã€Mapç­‰é›†åˆç±»å‹çš„å“åº”å¼ï¼Ÿ
5. computedçš„æ‡’è®¡ç®—æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿä»€ä¹ˆæ—¶å€™ä¼šé‡æ–°è®¡ç®—ï¼Ÿ


# ç¬¬äºŒé˜¶æ®µï¼šæ¸²æŸ“å™¨å’Œè™šæ‹ŸDOM => runtime

## ğŸ¯ é˜¶æ®µç›®æ ‡
æ·±å…¥ç†è§£Vue 3æ¸²æŸ“å™¨çš„è®¾è®¡åŸç†ï¼ŒæŒæ¡è™šæ‹ŸDOMã€diffç®—æ³•ã€DOMæ“ä½œç­‰æ ¸å¿ƒæ¦‚å¿µï¼Œç†è§£é«˜æ€§èƒ½æ¸²æŸ“çš„å®ç°ç­–ç•¥ã€‚

## ğŸ” æ ¸å¿ƒé—®é¢˜

### é—®é¢˜1ï¼šä»€ä¹ˆæ˜¯è™šæ‹ŸDOMï¼Ÿä¸ºä»€ä¹ˆéœ€è¦è™šæ‹ŸDOMï¼Ÿ
**å­¦ä¹ é‡ç‚¹ï¼š**
- è™šæ‹ŸDOMçš„æ¦‚å¿µå’Œä¼˜åŠ¿
- è™šæ‹ŸDOM vs ç›´æ¥DOMæ“ä½œçš„æ€§èƒ½å¯¹æ¯”
- è™šæ‹ŸDOMçš„æ•°æ®ç»“æ„è®¾è®¡

**ğŸ“‹ è¯¦ç»†è§£ç­”ï¼š**

**è™šæ‹ŸDOMçš„æ¦‚å¿µï¼š**
è™šæ‹ŸDOMï¼ˆVirtual DOMï¼‰æ˜¯ç”¨JavaScriptå¯¹è±¡æ¥æè¿°çœŸå®DOMç»“æ„çš„æŠ½è±¡è¡¨ç¤ºã€‚å®ƒæ˜¯ä¸€ä¸ªè½»é‡çº§çš„JavaScriptå¯¹è±¡ï¼ŒåŒ…å«äº†æè¿°ä¸€ä¸ªDOMèŠ‚ç‚¹æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä½†å®ƒæœ¬èº«å¹¶ä¸æ˜¯çœŸå®çš„DOMå…ƒç´ ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹ŸDOMï¼š**

1. **è·¨å¹³å°æŠ½è±¡**ï¼šè™šæ‹ŸDOMæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„ç¼–ç¨‹æ¥å£ï¼Œå¯ä»¥æ¸²æŸ“åˆ°ä¸åŒçš„å¹³å°ï¼ˆæµè§ˆå™¨DOMã€ç§»åŠ¨ç«¯ã€æœåŠ¡ç«¯ç­‰ï¼‰
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡diffç®—æ³•æ¯”è¾ƒæ–°æ—§è™šæ‹ŸDOMæ ‘ï¼Œå¯ä»¥æœ€å°åŒ–å®é™…çš„DOMæ“ä½œï¼Œæ‰¹é‡æ›´æ–°æå‡æ€§èƒ½
3. **å¼€å‘ä½“éªŒ**ï¼šæä¾›å£°æ˜å¼çš„ç¼–ç¨‹æ¨¡å¼ï¼Œå¼€å‘è€…åªéœ€è¦æè¿°UIåº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­ï¼Œè€Œä¸éœ€è¦å…³å¿ƒå¦‚ä½•æ“ä½œDOM
4. **æ—¶é—´æ—…è¡Œè°ƒè¯•**ï¼šå¯ä»¥ä¿å­˜è™šæ‹ŸDOMçš„çŠ¶æ€å¿«ç…§ï¼Œä¾¿äºè°ƒè¯•å’ŒçŠ¶æ€å›æº¯
5. **å‡½æ•°å¼UI**ï¼šä½¿UIæˆä¸ºçŠ¶æ€çš„çº¯å‡½æ•°ï¼Œä¾¿äºæµ‹è¯•å’Œæ¨ç†

**è™šæ‹ŸDOM vs ç›´æ¥DOMæ“ä½œçš„æ€§èƒ½å¯¹æ¯”ï¼š**
- **ç›´æ¥DOMæ“ä½œ**ï¼šæ¯æ¬¡ä¿®æ”¹éƒ½ç›´æ¥æ“ä½œçœŸå®DOMï¼Œå¯èƒ½è§¦å‘å¤šæ¬¡é‡æ’é‡ç»˜
- **è™šæ‹ŸDOM**ï¼šå…ˆåœ¨å†…å­˜ä¸­è®¡ç®—å‡ºæœ€å°å˜æ›´é›†ï¼Œç„¶åæ‰¹é‡åº”ç”¨åˆ°çœŸå®DOMï¼Œå‡å°‘é‡æ’é‡ç»˜æ¬¡æ•°

**å®è·µä»»åŠ¡ï¼š**
```javascript
// è®¾è®¡è™šæ‹ŸDOMèŠ‚ç‚¹ç»“æ„
const VNode = {
  type: 'div',           // æ ‡ç­¾åæˆ–ç»„ä»¶
  props: {               // å±æ€§å’Œäº‹ä»¶
    id: 'app',
    onClick: () => {}
  },
  children: [            // å­èŠ‚ç‚¹
    {
      type: 'span',
      props: null,
      children: 'Hello World'
    }
  ],
  el: null,              // å¯¹åº”çš„çœŸå®DOM
  key: null,             // ç”¨äºdiffçš„key
  patchFlag: 0,          // æ›´æ–°æ ‡è®°
  shapeFlag: 1           // èŠ‚ç‚¹ç±»å‹æ ‡è®°
}

// ShapeFlags - ç”¨äºæ ‡è¯†VNodeçš„ç±»å‹
const ShapeFlags = {
  ELEMENT: 1,                // æ™®é€šå…ƒç´ 
  FUNCTIONAL_COMPONENT: 2,   // å‡½æ•°ç»„ä»¶
  STATEFUL_COMPONENT: 4,     // æœ‰çŠ¶æ€ç»„ä»¶
  TEXT_CHILDREN: 8,          // æ–‡æœ¬å­èŠ‚ç‚¹
  ARRAY_CHILDREN: 16,        // æ•°ç»„å­èŠ‚ç‚¹
  SLOTS_CHILDREN: 32,        // æ’æ§½å­èŠ‚ç‚¹
  TELEPORT: 64,              // Teleportç»„ä»¶
  SUSPENSE: 128,             // Suspenseç»„ä»¶
  COMPONENT_SHOULD_KEEP_ALIVE: 256,
  COMPONENT_KEPT_ALIVE: 512,
  COMPONENT: 6 // FUNCTIONAL_COMPONENT | STATEFUL_COMPONENT
}

// åˆ›å»ºVNodeçš„å‡½æ•°å®ç°
function createVNode(type, props = null, children = null, patchFlag = 0, dynamicProps = null) {
  // ç¡®å®šshapeFlag
  const shapeFlag = typeof type === 'string' 
    ? ShapeFlags.ELEMENT 
    : typeof type === 'object'
    ? ShapeFlags.STATEFUL_COMPONENT
    : typeof type === 'function'
    ? ShapeFlags.FUNCTIONAL_COMPONENT
    : 0

  const vnode = {
    type,
    props,
    children,
    el: null,
    key: props && props.key,
    patchFlag,
    shapeFlag,
    dynamicProps
  }

  // æ ‡å‡†åŒ–childrenå¹¶è®¾ç½®å¯¹åº”çš„shapeFlag
  if (children) {
    if (typeof children === 'string' || typeof children === 'number') {
      vnode.shapeFlag |= ShapeFlags.TEXT_CHILDREN
    } else if (Array.isArray(children)) {
      vnode.shapeFlag |= ShapeFlags.ARRAY_CHILDREN
    }
  }

  return vnode
}

// ä¾¿æ·çš„hå‡½æ•°ï¼ˆç±»ä¼¼React.createElementï¼‰
function h(type, propsOrChildren, children) {
  const l = arguments.length
  if (l === 2) {
    if (typeof propsOrChildren === 'object' && !Array.isArray(propsOrChildren)) {
      // h('div', { id: 'app' })
      return createVNode(type, propsOrChildren)
    } else {
      // h('div', 'hello') æˆ– h('div', [...])
      return createVNode(type, null, propsOrChildren)
    }
  } else {
    // h('div', { id: 'app' }, 'hello') æˆ–æ›´å¤šå‚æ•°
    if (l > 3) {
      children = Array.prototype.slice.call(arguments, 2)
    } else if (l === 3 && !Array.isArray(children)) {
      children = [children]
    }
    return createVNode(type, propsOrChildren, children)
  }
}
```

**è®¾è®¡è¦ç‚¹ï¼š**
- **type**: å¿…é¡»å­—æ®µï¼Œæ ‡è¯†èŠ‚ç‚¹ç±»å‹ï¼ˆHTMLæ ‡ç­¾åæˆ–ç»„ä»¶ï¼‰
- **props**: å¯é€‰å­—æ®µï¼ŒåŒ…å«å±æ€§ã€äº‹ä»¶ç›‘å¬å™¨ç­‰
- **children**: å¯é€‰å­—æ®µï¼Œå­èŠ‚ç‚¹æ•°ç»„æˆ–æ–‡æœ¬å†…å®¹
- **el**: è¿è¡Œæ—¶å­—æ®µï¼ŒæŒ‡å‘å¯¹åº”çš„çœŸå®DOMå…ƒç´ 
- **key**: å¯é€‰å­—æ®µï¼Œç”¨äºdiffç®—æ³•ä¸­çš„èŠ‚ç‚¹è¯†åˆ«
- **patchFlag**: ç¼–è¯‘æ—¶ä¼˜åŒ–æ ‡è®°ï¼ŒæŒ‡ç¤ºå“ªäº›å±æ€§æ˜¯åŠ¨æ€çš„
- **shapeFlag**: è¿è¡Œæ—¶ç±»å‹æ ‡è®°ï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­èŠ‚ç‚¹ç±»å‹

### é—®é¢˜2ï¼šæ¸²æŸ“å™¨æ˜¯å¦‚ä½•å°†è™šæ‹ŸDOMè½¬æ¢ä¸ºçœŸå®DOMçš„ï¼Ÿ
**å­¦ä¹ é‡ç‚¹ï¼š**
- æ¸²æŸ“å™¨çš„åŸºæœ¬æ¶æ„
- æŒ‚è½½ï¼ˆmountï¼‰è¿‡ç¨‹
- å¦‚ä½•å¤„ç†ä¸åŒç±»å‹çš„èŠ‚ç‚¹

**ğŸ“‹ è¯¦ç»†è§£ç­”ï¼š**

**æ¸²æŸ“å™¨çš„åŸºæœ¬æ¶æ„ï¼š**

æ¸²æŸ“å™¨é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

1. **å¹³å°æ— å…³çš„æ ¸å¿ƒå±‚**ï¼šå¤„ç†è™šæ‹ŸDOMçš„é€»è¾‘ï¼ŒåŒ…æ‹¬diffç®—æ³•ã€ç»„ä»¶ç³»ç»Ÿç­‰
2. **å¹³å°ç›¸å…³çš„æ“ä½œå±‚**ï¼šæä¾›å…·ä½“å¹³å°çš„DOMæ“ä½œæ¥å£ï¼ˆå¦‚æµè§ˆå™¨DOMã€ç§»åŠ¨ç«¯ç­‰ï¼‰
3. **æŠ½è±¡æ¥å£å±‚**ï¼šé€šè¿‡nodeOpså’ŒpatchPropç­‰æ¥å£å®ç°å¹³å°é€‚é…

**æ¸²æŸ“æµç¨‹ï¼š**

1. **renderå‡½æ•°**ï¼šæ¸²æŸ“å™¨çš„å…¥å£å‡½æ•°ï¼Œè´Ÿè´£å¤„ç†æŒ‚è½½ã€æ›´æ–°å’Œå¸è½½
2. **patchå‡½æ•°**ï¼šæ ¸å¿ƒå‡½æ•°ï¼Œæ¯”è¾ƒæ–°æ—§VNodeå¹¶è¿›è¡Œç›¸åº”çš„DOMæ“ä½œ
3. **mountå‡½æ•°**ï¼šæŒ‚è½½æ–°çš„VNodeåˆ°DOM
4. **updateå‡½æ•°**ï¼šæ›´æ–°ç°æœ‰çš„DOMèŠ‚ç‚¹

**å®è·µä»»åŠ¡ï¼š**
```javascript
// å®ç°åŸºç¡€æ¸²æŸ“å™¨
function createRenderer(options) {
  const {
    createElement,
    insert,
    remove,
    patchProp,
    createText,
    createComment,
    setText,
    setElementText
  } = options

  // æ¸²æŸ“å‡½æ•° - æ¸²æŸ“å™¨çš„å…¥å£
  function render(vnode, container) {
    if (vnode) {
      // æŒ‚è½½æˆ–æ›´æ–°
      patch(container._vnode, vnode, container)
    } else {
      // å¸è½½
      if (container._vnode) {
        unmount(container._vnode)
      }
    }
    container._vnode = vnode
  }

  // æ ¸å¿ƒpatchå‡½æ•° - æ¯”è¾ƒæ–°æ—§VNode
  function patch(n1, n2, container, anchor = null) {
    // å¦‚æœæ–°æ—§èŠ‚ç‚¹ç±»å‹ä¸åŒï¼Œç›´æ¥å¸è½½æ—§èŠ‚ç‚¹
    if (n1 && !isSameVNodeType(n1, n2)) {
      unmount(n1)
      n1 = null
    }

    const { type, shapeFlag } = n2

    switch (type) {
      case Text:
        processText(n1, n2, container, anchor)
        break
      case Comment:
        processComment(n1, n2, container, anchor)
        break
      case Fragment:
        processFragment(n1, n2, container, anchor)
        break
      default:
        if (shapeFlag & ShapeFlags.ELEMENT) {
          // å¤„ç†æ™®é€šå…ƒç´ 
          processElement(n1, n2, container, anchor)
        } else if (shapeFlag & ShapeFlags.COMPONENT) {
          // å¤„ç†ç»„ä»¶
          processComponent(n1, n2, container, anchor)
        }
    }
  }

  // å¤„ç†å…ƒç´ èŠ‚ç‚¹
  function processElement(n1, n2, container, anchor) {
    if (n1 == null) {
      // æŒ‚è½½å…ƒç´ 
      mountElement(n2, container, anchor)
    } else {
      // æ›´æ–°å…ƒç´ 
      patchElement(n1, n2)
    }
  }

  // æŒ‚è½½å…ƒç´ 
  function mountElement(vnode, container, anchor) {
    const { type, props, children, shapeFlag } = vnode
    
    // 1. åˆ›å»ºDOMå…ƒç´ 
    const el = vnode.el = createElement(type)
    
    // 2. å¤„ç†props
    if (props) {
      for (const key in props) {
        patchProp(el, key, null, props[key])
      }
    }
    
    // 3. å¤„ç†children
    if (shapeFlag & ShapeFlags.TEXT_CHILDREN) {
      // æ–‡æœ¬å­èŠ‚ç‚¹
      setElementText(el, children)
    } else if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
      // æ•°ç»„å­èŠ‚ç‚¹
      mountChildren(children, el)
    }
    
    // 4. æ’å…¥åˆ°å®¹å™¨ä¸­
    insert(el, container, anchor)
  }

  // æŒ‚è½½å­èŠ‚ç‚¹æ•°ç»„
  function mountChildren(children, container, anchor = null) {
    for (let i = 0; i < children.length; i++) {
      const child = children[i]
      patch(null, child, container, anchor)
    }
  }

  // æ›´æ–°å…ƒç´ 
  function patchElement(n1, n2) {
    const el = n2.el = n1.el
    const oldProps = n1.props || {}
    const newProps = n2.props || {}
    
    // æ›´æ–°props
    patchProps(el, oldProps, newProps)
    
    // æ›´æ–°children
    patchChildren(n1, n2, el)
  }

  // æ›´æ–°å±æ€§
  function patchProps(el, oldProps, newProps) {
    // æ›´æ–°æ–°å±æ€§
    for (const key in newProps) {
      const prev = oldProps[key]
      const next = newProps[key]
      if (prev !== next) {
        patchProp(el, key, prev, next)
      }
    }
    
    // åˆ é™¤æ—§å±æ€§
    for (const key in oldProps) {
      if (!(key in newProps)) {
        patchProp(el, key, oldProps[key], null)
      }
    }
  }

  // å¤„ç†æ–‡æœ¬èŠ‚ç‚¹
  function processText(n1, n2, container, anchor) {
    if (n1 == null) {
      // æŒ‚è½½æ–‡æœ¬
      const el = n2.el = createText(n2.children)
      insert(el, container, anchor)
    } else {
      // æ›´æ–°æ–‡æœ¬
      const el = n2.el = n1.el
      if (n2.children !== n1.children) {
        setText(el, n2.children)
      }
    }
  }

  // å¸è½½èŠ‚ç‚¹
  function unmount(vnode) {
    const { shapeFlag } = vnode
    if (shapeFlag & ShapeFlags.COMPONENT) {
      // å¸è½½ç»„ä»¶
      unmountComponent(vnode)
    } else if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
      // å¸è½½å­èŠ‚ç‚¹
      vnode.children.forEach(child => unmount(child))
    }
    // ç§»é™¤DOMèŠ‚ç‚¹
    remove(vnode.el)
  }

  // åˆ¤æ–­æ˜¯å¦ä¸ºç›¸åŒç±»å‹çš„VNode
  function isSameVNodeType(n1, n2) {
    return n1.type === n2.type && n1.key === n2.key
  }

  return {
    render,
    createApp: createAppAPI(render)
  }
}

// æµè§ˆå™¨å¹³å°çš„DOMæ“ä½œ
const nodeOps = {
  createElement: (tag) => document.createElement(tag),
  insert: (child, parent, anchor) => {
    parent.insertBefore(child, anchor || null)
  },
  remove: (child) => {
    const parent = child.parentNode
    if (parent) {
      parent.removeChild(child)
    }
  },
  createText: (text) => document.createTextNode(text),
  createComment: (text) => document.createComment(text),
  setText: (node, text) => {
    node.nodeValue = text
  },
  setElementText: (el, text) => {
    el.textContent = text
  }
}

// åˆ›å»ºæµè§ˆå™¨æ¸²æŸ“å™¨
const renderer = createRenderer({
  ...nodeOps,
  patchProp // å±æ€§æ›´æ–°å‡½æ•°
})
```

**å…³é”®è®¾è®¡åŸåˆ™ï¼š**

1. **å¹³å°æŠ½è±¡**ï¼šé€šè¿‡optionså‚æ•°ä¼ å…¥å¹³å°ç›¸å…³çš„æ“ä½œï¼Œä½¿æ¸²æŸ“å™¨æ ¸å¿ƒé€»è¾‘å¹³å°æ— å…³
2. **é€’å½’å¤„ç†**ï¼šé€šè¿‡é€’å½’è°ƒç”¨patchå‡½æ•°å¤„ç†VNodeæ ‘
3. **ç±»å‹åˆ†å‘**ï¼šæ ¹æ®VNodeçš„typeå’ŒshapeFlagåˆ†å‘åˆ°ä¸åŒçš„å¤„ç†å‡½æ•°
4. **å¢é‡æ›´æ–°**ï¼šåªæ›´æ–°å‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯é‡æ–°åˆ›å»ºæ•´ä¸ªDOMæ ‘
5. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šæ­£ç¡®å¤„ç†èŠ‚ç‚¹çš„æŒ‚è½½ã€æ›´æ–°å’Œå¸è½½è¿‡ç¨‹

### é—®é¢˜3ï¼šdiffç®—æ³•æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ
**å­¦ä¹ é‡ç‚¹ï¼š**
- diffç®—æ³•çš„æ ¸å¿ƒæ€æƒ³
- åŒå±‚æ¯”è¾ƒçš„åŸç†
- keyçš„ä½œç”¨å’Œé‡è¦æ€§

**ğŸ“‹ è¯¦ç»†è§£ç­”ï¼š**

**diffç®—æ³•çš„æ ¸å¿ƒæ€æƒ³ï¼š**

diffç®—æ³•æ˜¯è™šæ‹ŸDOMçš„æ ¸å¿ƒï¼Œå®ƒçš„ç›®æ ‡æ˜¯æ‰¾å‡ºæ–°æ—§è™šæ‹ŸDOMæ ‘ä¹‹é—´çš„å·®å¼‚ï¼Œå¹¶ä»¥æœ€å°çš„ä»£ä»·æ›´æ–°çœŸå®DOMã€‚

**æ ¸å¿ƒåŸåˆ™ï¼š**

1. **åŒå±‚æ¯”è¾ƒ**ï¼šåªæ¯”è¾ƒåŒä¸€å±‚çº§çš„èŠ‚ç‚¹ï¼Œä¸ä¼šè·¨å±‚çº§æ¯”è¾ƒï¼Œè¿™å°†ç®—æ³•å¤æ‚åº¦ä»O(nÂ³)é™ä½åˆ°O(n)
2. **ç±»å‹ä¼˜å…ˆ**ï¼šä¸åŒç±»å‹çš„èŠ‚ç‚¹ä¼šè¢«è®¤ä¸ºæ˜¯å®Œå…¨ä¸åŒçš„æ ‘ï¼Œç›´æ¥æ›¿æ¢è€Œä¸æ˜¯ä¿®è¡¥
3. **keyæ ‡è¯†**ï¼šä½¿ç”¨keyæ¥è¯†åˆ«èŠ‚ç‚¹ï¼Œå¸®åŠ©ç®—æ³•è¯†åˆ«å“ªäº›èŠ‚ç‚¹å¯ä»¥å¤ç”¨
4. **å¯å‘å¼ç­–ç•¥**ï¼šåŸºäºå¸¸è§çš„DOMæ“ä½œæ¨¡å¼è¿›è¡Œä¼˜åŒ–

**åŒå±‚æ¯”è¾ƒçš„åŸç†ï¼š**

```
æ—§æ ‘:     A          æ–°æ ‘:     A
        /   \                 /   \
       B     C               D     C
      /     / \             /     / \
     D     E   F           B     E   G

ç®—æ³•åªä¼šæ¯”è¾ƒï¼š
- A ä¸ A (æ ¹èŠ‚ç‚¹)
- B,C ä¸ D,C (ç¬¬äºŒå±‚)
- D ä¸ B, E,F ä¸ E,G (ç¬¬ä¸‰å±‚)
```

**keyçš„ä½œç”¨å’Œé‡è¦æ€§ï¼š**

1. **èŠ‚ç‚¹è¯†åˆ«**ï¼šå¸®åŠ©ç®—æ³•è¯†åˆ«å“ªäº›èŠ‚ç‚¹æ˜¯ç›¸åŒçš„ï¼Œå“ªäº›æ˜¯æ–°å¢æˆ–åˆ é™¤çš„
2. **å¤ç”¨ä¼˜åŒ–**ï¼šç›¸åŒkeyçš„èŠ‚ç‚¹å¯ä»¥å¤ç”¨ï¼Œé¿å…ä¸å¿…è¦çš„é”€æ¯å’Œé‡å»º
3. **ç§»åŠ¨æ£€æµ‹**ï¼šé€šè¿‡keyå¯ä»¥æ£€æµ‹åˆ°èŠ‚ç‚¹çš„ç§»åŠ¨ï¼Œè€Œä¸æ˜¯åˆ é™¤åé‡æ–°åˆ›å»º

**å®è·µä»»åŠ¡ï¼š**
```javascript
// å®ç°å®Œæ•´çš„children diffç®—æ³•
function patchChildren(n1, n2, container, anchor) {
  const c1 = n1 && n1.children
  const c2 = n2.children
  const prevShapeFlag = n1 ? n1.shapeFlag : 0
  const shapeFlag = n2.shapeFlag

  // æ–°childrenæ˜¯æ–‡æœ¬
  if (shapeFlag & ShapeFlags.TEXT_CHILDREN) {
    // æ—§childrenæ˜¯æ•°ç»„ï¼Œéœ€è¦å¸è½½
    if (prevShapeFlag & ShapeFlags.ARRAY_CHILDREN) {
      unmountChildren(c1)
    }
    // è®¾ç½®æ–‡æœ¬å†…å®¹
    if (c2 !== c1) {
      setElementText(container, c2)
    }
  } else {
    // æ–°childrenæ˜¯æ•°ç»„æˆ–null
    if (prevShapeFlag & ShapeFlags.ARRAY_CHILDREN) {
      // æ—§childrenæ˜¯æ•°ç»„
      if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
        // æ–°æ—§éƒ½æ˜¯æ•°ç»„ï¼Œè¿›è¡Œå®Œæ•´diff
        patchKeyedChildren(c1, c2, container, anchor)
      } else {
        // æ–°childrenæ˜¯nullï¼Œå¸è½½æ—§children
        unmountChildren(c1)
      }
    } else {
      // æ—§childrenæ˜¯æ–‡æœ¬æˆ–null
      if (prevShapeFlag & ShapeFlags.TEXT_CHILDREN) {
        // æ¸…ç©ºæ–‡æœ¬
        setElementText(container, '')
      }
      // æŒ‚è½½æ–°çš„æ•°ç»„children
      if (shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
        mountChildren(c2, container, anchor)
      }
    }
  }
}

// å¸è½½å­èŠ‚ç‚¹æ•°ç»„
function unmountChildren(children) {
  for (let i = 0; i < children.length; i++) {
    unmount(children[i])
  }
}

// ç®€å•çš„æ— key diffç®—æ³•
function patchUnkeyedChildren(c1, c2, container, anchor) {
  c1 = c1 || []
  c2 = c2 || []
  const oldLength = c1.length
  const newLength = c2.length
  const commonLength = Math.min(oldLength, newLength)
  let i

  // æ›´æ–°å…¬å…±éƒ¨åˆ†
  for (i = 0; i < commonLength; i++) {
    patch(c1[i], c2[i], container, anchor)
  }

  // æŒ‚è½½æ–°å¢çš„èŠ‚ç‚¹
  if (newLength > oldLength) {
    mountChildren(c2.slice(commonLength), container, anchor)
  } else if (newLength < oldLength) {
    // å¸è½½å¤šä½™çš„èŠ‚ç‚¹
    unmountChildren(c1.slice(commonLength))
  }
}

// åˆ¤æ–­ä¸¤ä¸ªVNodeæ˜¯å¦å¯ä»¥å¤ç”¨
function isSameVNodeType(n1, n2) {
  return n1.type === n2.type && n1.key === n2.key
}

// ç¤ºä¾‹ï¼škeyçš„é‡è¦æ€§
// æ²¡æœ‰keyçš„æƒ…å†µï¼š
const oldList = [
  { type: 'li', children: 'A' },
  { type: 'li', children: 'B' },
  { type: 'li', children: 'C' }
]

const newList = [
  { type: 'li', children: 'D' },
  { type: 'li', children: 'A' },
  { type: 'li', children: 'B' },
  { type: 'li', children: 'C' }
]
// æ²¡æœ‰keyæ—¶ï¼Œç®—æ³•ä¼šè®¤ä¸ºï¼šA->D, B->A, C->B, ç„¶åæ–°å¢C
// éœ€è¦3æ¬¡æ›´æ–° + 1æ¬¡æ’å…¥

// æœ‰keyçš„æƒ…å†µï¼š
const oldListWithKey = [
  { type: 'li', key: 'A', children: 'A' },
  { type: 'li', key: 'B', children: 'B' },
  { type: 'li', key: 'C', children: 'C' }
]

const newListWithKey = [
  { type: 'li', key: 'D', children: 'D' },
  { type: 'li', key: 'A', children: 'A' },
  { type: 'li', key: 'B', children: 'B' },
  { type: 'li', key: 'C', children: 'C' }
]
// æœ‰keyæ—¶ï¼Œç®—æ³•èƒ½è¯†åˆ«å‡ºAã€Bã€Céƒ½æ˜¯å¤ç”¨çš„ï¼Œåªéœ€è¦æ’å…¥D
// åªéœ€è¦1æ¬¡æ’å…¥æ“ä½œ
```

**diffç®—æ³•çš„ä¼˜åŒ–ç­–ç•¥ï¼š**

1. **é¢„å¤„ç†ä¼˜åŒ–**ï¼š
   - å¤´éƒ¨ç›¸åŒèŠ‚ç‚¹çš„å¿«é€Ÿè·³è¿‡
   - å°¾éƒ¨ç›¸åŒèŠ‚ç‚¹çš„å¿«é€Ÿè·³è¿‡
   - çº¯æ–°å¢æˆ–çº¯åˆ é™¤çš„å¿«é€Ÿå¤„ç†

2. **å¯å‘å¼ä¼˜åŒ–**ï¼š
   - åŸºäºå¸¸è§çš„DOMæ“ä½œæ¨¡å¼ï¼ˆå¦‚åˆ—è¡¨çš„å¤´éƒ¨/å°¾éƒ¨æ’å…¥ï¼‰
   - åˆ©ç”¨æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•æœ€å°åŒ–ç§»åŠ¨æ¬¡æ•°

3. **ç±»å‹ä¼˜åŒ–**ï¼š
   - ä¸åŒç±»å‹çš„èŠ‚ç‚¹ç›´æ¥æ›¿æ¢
   - ç›¸åŒç±»å‹çš„èŠ‚ç‚¹è¿›è¡Œå±æ€§å’Œå­èŠ‚ç‚¹çš„diff

**æ€§èƒ½è€ƒè™‘ï¼š**

- **æ—¶é—´å¤æ‚åº¦**ï¼šO(n) å¯¹äºå¤§å¤šæ•°æƒ…å†µ
- **ç©ºé—´å¤æ‚åº¦**ï¼šO(n) ç”¨äºå­˜å‚¨keyæ˜ å°„å’Œç§»åŠ¨ä¿¡æ¯
- **å®é™…æ€§èƒ½**ï¼šé€šè¿‡å‡å°‘DOMæ“ä½œæ¬¡æ•°æ¥æå‡å®é™…æ€§èƒ½

### é—®é¢˜4ï¼šå¦‚ä½•é«˜æ•ˆåœ°æ›´æ–°åˆ—è¡¨ï¼Ÿ
**å­¦ä¹ é‡ç‚¹ï¼š**
- æœ‰keyå’Œæ— keyçš„diffå·®å¼‚
- æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•
- Vue3çš„åŒç«¯+æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•

**ğŸ“‹ è¯¦ç»†è§£ç­”ï¼š**

**æœ‰keyå’Œæ— keyçš„diffå·®å¼‚ï¼š**

1. **æ— keyçš„diff**ï¼š
   - åªèƒ½æŒ‰ä½ç½®è¿›è¡Œæ¯”è¾ƒ
   - æ— æ³•è¯†åˆ«èŠ‚ç‚¹çš„ç§»åŠ¨
   - æ€§èƒ½è¾ƒå·®ï¼Œå¯èƒ½å¯¼è‡´å¤§é‡ä¸å¿…è¦çš„DOMæ“ä½œ

2. **æœ‰keyçš„diff**ï¼š
   - å¯ä»¥é€šè¿‡keyè¯†åˆ«ç›¸åŒçš„èŠ‚ç‚¹
   - èƒ½å¤Ÿæ£€æµ‹èŠ‚ç‚¹çš„ç§»åŠ¨ã€æ–°å¢ã€åˆ é™¤
   - æ€§èƒ½æ›´å¥½ï¼Œèƒ½å¤Ÿæœ€å¤§åŒ–èŠ‚ç‚¹å¤ç”¨

**Vue3çš„åŒç«¯+æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•ï¼š**

Vue3é‡‡ç”¨äº†ä¸€ç§é«˜æ•ˆçš„diffç®—æ³•ï¼Œç»“åˆäº†åŒç«¯æ¯”è¾ƒå’Œæœ€é•¿é€’å¢å­åºåˆ—ï¼ˆLISï¼‰ç®—æ³•ï¼š

1. **åŒç«¯æ¯”è¾ƒ**ï¼šä»å¤´éƒ¨å’Œå°¾éƒ¨åŒæ—¶å¼€å§‹æ¯”è¾ƒï¼Œå¿«é€Ÿå¤„ç†å¸¸è§æƒ…å†µ
2. **æœ€é•¿é€’å¢å­åºåˆ—**ï¼šå¯¹äºå¤æ‚çš„ä¸­é—´éƒ¨åˆ†ï¼Œä½¿ç”¨LISç®—æ³•æœ€å°åŒ–ç§»åŠ¨æ¬¡æ•°

**ç®—æ³•æ­¥éª¤ï¼š**

1. **å¤´éƒ¨é¢„å¤„ç†**ï¼šä»å‰å¾€åæ¯”è¾ƒç›¸åŒçš„èŠ‚ç‚¹
2. **å°¾éƒ¨é¢„å¤„ç†**ï¼šä»åå¾€å‰æ¯”è¾ƒç›¸åŒçš„èŠ‚ç‚¹
3. **çº¯æ–°å¢å¤„ç†**ï¼šå¦‚æœæ—§åˆ—è¡¨å·²ç»å¤„ç†å®Œï¼Œå‰©ä¸‹çš„éƒ½æ˜¯æ–°å¢
4. **çº¯åˆ é™¤å¤„ç†**ï¼šå¦‚æœæ–°åˆ—è¡¨å·²ç»å¤„ç†å®Œï¼Œå‰©ä¸‹çš„éƒ½æ˜¯åˆ é™¤
5. **å¤æ‚æƒ…å†µå¤„ç†**ï¼šä½¿ç”¨æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•å¤„ç†ç§»åŠ¨

**å®è·µä»»åŠ¡ï¼š**
```javascript
// å®ç°Vue3é£æ ¼çš„åˆ—è¡¨diffç®—æ³•
function patchKeyedChildren(c1, c2, container, parentAnchor) {
  let i = 0
  const l2 = c2.length
  let e1 = c1.length - 1 // æ—§åˆ—è¡¨çš„ç»“æŸç´¢å¼•
  let e2 = l2 - 1        // æ–°åˆ—è¡¨çš„ç»“æŸç´¢å¼•

  // 1. ä»å¤´å¼€å§‹åŒæ­¥
  // (a b) c
  // (a b) d e
  while (i <= e1 && i <= e2) {
    const n1 = c1[i]
    const n2 = c2[i]
    if (isSameVNodeType(n1, n2)) {
      patch(n1, n2, container, null)
    } else {
      break
    }
    i++
  }

  // 2. ä»å°¾å¼€å§‹åŒæ­¥
  // a (b c)
  // d e (b c)
  while (i <= e1 && i <= e2) {
    const n1 = c1[e1]
    const n2 = c2[e2]
    if (isSameVNodeType(n1, n2)) {
      patch(n1, n2, container, null)
    } else {
      break
    }
    e1--
    e2--
  }

  // 3. å¸¸è§åºåˆ—æŒ‚è½½
  // (a b)
  // (a b) c
  // i = 2, e1 = 1, e2 = 2
  // (a b)
  // c (a b)
  // i = 0, e1 = -1, e2 = 0
  if (i > e1) {
    if (i <= e2) {
      const nextPos = e2 + 1
      const anchor = nextPos < l2 ? c2[nextPos].el : parentAnchor
      while (i <= e2) {
        patch(null, c2[i], container, anchor)
        i++
      }
    }
  }
  // 4. å¸¸è§åºåˆ—å¸è½½
  // (a b) c
  // (a b)
  // i = 2, e1 = 2, e2 = 1
  // a (b c)
  // (b c)
  // i = 0, e1 = 0, e2 = -1
  else if (i > e2) {
    while (i <= e1) {
      unmount(c1[i])
      i++
    }
  }
  // 5. æœªçŸ¥åºåˆ—
  // [i ... e1 + 1]: a b [c d e] f g
  // [i ... e2 + 1]: a b [e d c h] f g
  // i = 2, e1 = 4, e2 = 5
  else {
    const s1 = i // æ—§åˆ—è¡¨å¼€å§‹ç´¢å¼•
    const s2 = i // æ–°åˆ—è¡¨å¼€å§‹ç´¢å¼•

    // 5.1 ä¸ºæ–°åˆ—è¡¨æ„å»ºkey:indexæ˜ å°„
    const keyToNewIndexMap = new Map()
    for (i = s2; i <= e2; i++) {
      const nextChild = c2[i]
      if (nextChild.key != null) {
        keyToNewIndexMap.set(nextChild.key, i)
      }
    }

    // 5.2 å¾ªç¯éå†æ—§åˆ—è¡¨ï¼Œå°è¯•patchåŒ¹é…çš„èŠ‚ç‚¹å¹¶ç§»é™¤ä¸å­˜åœ¨çš„èŠ‚ç‚¹
    let j
    let patched = 0
    const toBePatched = e2 - s2 + 1
    let moved = false
    let maxNewIndexSoFar = 0
    
    // ç”¨äºè·Ÿè¸ªæ˜¯å¦æœ‰èŠ‚ç‚¹è¢«ç§»åŠ¨
    const newIndexToOldIndexMap = new Array(toBePatched)
    for (i = 0; i < toBePatched; i++) newIndexToOldIndexMap[i] = 0

    for (i = s1; i <= e1; i++) {
      const prevChild = c1[i]
      if (patched >= toBePatched) {
        // æ‰€æœ‰æ–°èŠ‚ç‚¹éƒ½å·²ç»è¢«patchï¼Œå‰©ä½™çš„æ—§èŠ‚ç‚¹éœ€è¦è¢«ç§»é™¤
        unmount(prevChild)
        continue
      }
      let newIndex
      if (prevChild.key != null) {
        newIndex = keyToNewIndexMap.get(prevChild.key)
      } else {
        // keyä¸ºnullï¼Œå°è¯•å®šä½ç›¸åŒç±»å‹çš„èŠ‚ç‚¹
        for (j = s2; j <= e2; j++) {
          if (
            newIndexToOldIndexMap[j - s2] === 0 &&
            isSameVNodeType(prevChild, c2[j])
          ) {
            newIndex = j
            break
          }
        }
      }
      if (newIndex === undefined) {
        unmount(prevChild)
      } else {
        newIndexToOldIndexMap[newIndex - s2] = i + 1
        if (newIndex >= maxNewIndexSoFar) {
          maxNewIndexSoFar = newIndex
        } else {
          moved = true
        }
        patch(prevChild, c2[newIndex], container, null)
        patched++
      }
    }

    // 5.3 ç§»åŠ¨å¹¶æŒ‚è½½
    // å½“èŠ‚ç‚¹è¢«ç§»åŠ¨æ—¶ï¼Œç”Ÿæˆæœ€é•¿é€’å¢å­åºåˆ—
    const increasingNewIndexSequence = moved
      ? getSequence(newIndexToOldIndexMap)
      : []
    j = increasingNewIndexSequence.length - 1
    // ä»åå¾€å‰éå†ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æœ€åä¸€ä¸ªpatchçš„èŠ‚ç‚¹ä½œä¸ºé”šç‚¹
    for (i = toBePatched - 1; i >= 0; i--) {
      const nextIndex = s2 + i
      const nextChild = c2[nextIndex]
      const anchor = nextIndex + 1 < l2 ? c2[nextIndex + 1].el : parentAnchor
      if (newIndexToOldIndexMap[i] === 0) {
        // æŒ‚è½½æ–°èŠ‚ç‚¹
        patch(null, nextChild, container, anchor)
      } else if (moved) {
        // ç§»åŠ¨èŠ‚ç‚¹
        if (j < 0 || i !== increasingNewIndexSequence[j]) {
          move(nextChild, container, anchor)
        } else {
          j--
        }
      }
    }
  }
}

// æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•å®ç°
function getSequence(arr) {
  const p = arr.slice() // å¤åˆ¶æ•°ç»„
  const result = [0]
  let i, j, u, v, c
  const len = arr.length
  
  for (i = 0; i < len; i++) {
    const arrI = arr[i]
    if (arrI !== 0) {
      j = result[result.length - 1]
      if (arr[j] < arrI) {
        p[i] = j
        result.push(i)
        continue
      }
      u = 0
      v = result.length - 1
      while (u < v) {
        c = (u + v) >> 1
        if (arr[result[c]] < arrI) {
          u = c + 1
        } else {
          v = c
        }
      }
      if (arrI < arr[result[u]]) {
        if (u > 0) {
          p[i] = result[u - 1]
        }
        result[u] = i
      }
    }
  }
  u = result.length
  v = result[u - 1]
  while (u-- > 0) {
    result[u] = v
    v = p[v]
  }
  return result
}

// ç§»åŠ¨èŠ‚ç‚¹
function move(vnode, container, anchor) {
  const { el } = vnode
  container.insertBefore(el, anchor)
}
```

**ç®—æ³•ä¼˜åŠ¿åˆ†æï¼š**

1. **æ—¶é—´å¤æ‚åº¦**ï¼š
   - æœ€å¥½æƒ…å†µï¼šO(n) - å½“åˆ—è¡¨åªæœ‰å¤´éƒ¨æˆ–å°¾éƒ¨å˜åŒ–æ—¶
   - æœ€åæƒ…å†µï¼šO(n log n) - éœ€è¦è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ—æ—¶
   - å¹³å‡æƒ…å†µï¼šæ¥è¿‘O(n)

2. **ç©ºé—´å¤æ‚åº¦**ï¼šO(n) - ç”¨äºå­˜å‚¨æ˜ å°„å’ŒLISä¿¡æ¯

3. **å®é™…æ€§èƒ½**ï¼š
   - æœ€å°åŒ–DOMç§»åŠ¨æ“ä½œ
   - æœ€å¤§åŒ–èŠ‚ç‚¹å¤ç”¨
   - é’ˆå¯¹å¸¸è§åœºæ™¯è¿›è¡Œä¼˜åŒ–

**ä¸ºä»€ä¹ˆéœ€è¦æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•ï¼Ÿ**

æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•ç”¨äºæ‰¾å‡ºä¸éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹åºåˆ—ï¼Œä»è€Œæœ€å°åŒ–DOMç§»åŠ¨æ“ä½œï¼š

```javascript
// ç¤ºä¾‹ï¼š
// æ—§åˆ—è¡¨ï¼š[A, B, C, D, E]
// æ–°åˆ—è¡¨ï¼š[A, C, B, E, D]
// 
// æ˜ å°„å…³ç³»ï¼šA->A, B->C, C->B, D->E, E->D
// æ–°ä½ç½®ç´¢å¼•ï¼š[0, 2, 1, 4, 3]
// 
// æœ€é•¿é€’å¢å­åºåˆ—ï¼š[0, 2, 4] å¯¹åº” [A, B, E]
// è¿™æ„å‘³ç€Aã€Bã€Eä¸éœ€è¦ç§»åŠ¨ï¼Œåªéœ€è¦ç§»åŠ¨Cå’ŒD
```

**æ€§èƒ½ä¼˜åŒ–è¦ç‚¹ï¼š**

1. **é¢„å¤„ç†ä¼˜åŒ–**ï¼šå¿«é€Ÿå¤„ç†å¤´éƒ¨å’Œå°¾éƒ¨çš„ç›¸åŒèŠ‚ç‚¹
2. **å¯å‘å¼æ£€æµ‹**ï¼šé€šè¿‡maxNewIndexSoFaræ£€æµ‹æ˜¯å¦éœ€è¦ç§»åŠ¨
3. **æ‰¹é‡æ“ä½œ**ï¼šä»åå¾€å‰å¤„ç†ï¼Œå‡å°‘DOMæ“ä½œæ¬¡æ•°
4. **ç®—æ³•é€‰æ‹©**ï¼šåªåœ¨å¿…è¦æ—¶è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ—

### é—®é¢˜5ï¼šå¦‚ä½•å¤„ç†ç»„ä»¶çš„æ¸²æŸ“ï¼Ÿ
**å­¦ä¹ é‡ç‚¹ï¼š**
- ç»„ä»¶vnodeçš„ç»“æ„
- ç»„ä»¶å®ä¾‹çš„åˆ›å»ºå’Œç®¡ç†
- ç»„ä»¶çš„æŒ‚è½½å’Œæ›´æ–°æµç¨‹

**ğŸ“‹ è¯¦ç»†è§£ç­”ï¼š**

**ç»„ä»¶vnodeçš„ç»“æ„ï¼š**

ç»„ä»¶VNodeä¸æ™®é€šå…ƒç´ VNodeçš„ä¸»è¦åŒºåˆ«ï¼š

```javascript
// å…ƒç´ VNode
const elementVNode = {
  type: 'div',           // HTMLæ ‡ç­¾å
  props: { id: 'app' },
  children: [...]
}

// ç»„ä»¶VNode
const componentVNode = {
  type: MyComponent,     // ç»„ä»¶å¯¹è±¡æˆ–å‡½æ•°
  props: { msg: 'hello' },
  children: null,        // ç»„ä»¶çš„childrené€šå¸¸æ˜¯slots
  component: null        // ç»„ä»¶å®ä¾‹ï¼Œè¿è¡Œæ—¶åˆ›å»º
}
```

**ç»„ä»¶å®ä¾‹çš„åˆ›å»ºå’Œç®¡ç†ï¼š**

ç»„ä»¶å®ä¾‹åŒ…å«ç»„ä»¶è¿è¡Œæ—¶éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼š

1. **çŠ¶æ€ç®¡ç†**ï¼šdataã€computedã€methodsç­‰
2. **ç”Ÿå‘½å‘¨æœŸ**ï¼šmountedã€updatedã€unmountedç­‰é’©å­
3. **æ¸²æŸ“ä¸Šä¸‹æ–‡**ï¼šrenderå‡½æ•°ã€æ¨¡æ¿ç¼–è¯‘ç»“æœç­‰
4. **ä¾èµ–è¿½è¸ª**ï¼šå“åº”å¼ä¾èµ–ã€æ›´æ–°è°ƒåº¦ç­‰

**ç»„ä»¶çš„æŒ‚è½½å’Œæ›´æ–°æµç¨‹ï¼š**

1. **æŒ‚è½½é˜¶æ®µ**ï¼šåˆ›å»ºå®ä¾‹ â†’ åˆå§‹åŒ– â†’ é¦–æ¬¡æ¸²æŸ“ â†’ æŒ‚è½½åˆ°DOM
2. **æ›´æ–°é˜¶æ®µ**ï¼šå“åº”å¼æ•°æ®å˜åŒ– â†’ è§¦å‘é‡æ¸²æŸ“ â†’ diffæ›´æ–° â†’ åº”ç”¨åˆ°DOM
3. **å¸è½½é˜¶æ®µ**ï¼šæ¸…ç†å‰¯ä½œç”¨ â†’ å¸è½½å­ç»„ä»¶ â†’ ç§»é™¤DOM

**å®è·µä»»åŠ¡ï¼š**
```javascript
// å¤„ç†ç»„ä»¶æ¸²æŸ“çš„å®Œæ•´å®ç°
function processComponent(n1, n2, container, anchor) {
  if (n1 == null) {
    // æŒ‚è½½ç»„ä»¶
    mountComponent(n2, container, anchor)
  } else {
    // æ›´æ–°ç»„ä»¶
    updateComponent(n1, n2)
  }
}

// æŒ‚è½½ç»„ä»¶
function mountComponent(initialVNode, container, anchor) {
  // 1. åˆ›å»ºç»„ä»¶å®ä¾‹
  const instance = initialVNode.component = createComponentInstance(
    initialVNode,
    null, // parent
    null  // suspense
  )

  // 2. è®¾ç½®ç»„ä»¶å®ä¾‹
  setupComponent(instance)

  // 3. è®¾ç½®æ¸²æŸ“å‰¯ä½œç”¨
  setupRenderEffect(instance, initialVNode, container, anchor)
}

// åˆ›å»ºç»„ä»¶å®ä¾‹
function createComponentInstance(vnode, parent, suspense) {
  const type = vnode.type
  const instance = {
    uid: uid++,
    vnode,
    type,
    parent,
    appContext: parent ? parent.appContext : null,
    root: null,
    next: null,
    subTree: null,
    update: null,
    render: null,
    proxy: null,
    exposed: null,
    withProxy: null,
    effects: null,
    provides: parent ? parent.provides : Object.create(null),
    accessCache: null,
    renderCache: [],
    
    // çŠ¶æ€
    ctx: {},
    data: {},
    props: {},
    attrs: {},
    slots: {},
    refs: {},
    emit: null,
    
    // ç”Ÿå‘½å‘¨æœŸ
    isMounted: false,
    isUnmounted: false,
    isDeactivated: false,
    bc: null, // beforeCreate
    c: null,  // created
    bm: null, // beforeMount
    m: null,  // mounted
    bu: null, // beforeUpdate
    u: null,  // updated
    um: null, // unmounted
    bum: null, // beforeUnmount
    
    // å¼‚æ­¥ç»„ä»¶
    asyncDep: null,
    asyncResolved: false,
    
    // suspenseç›¸å…³
    suspense,
    suspenseId: suspense ? suspense.pendingId : 0,
    
    // é”™è¯¯å¤„ç†
    errorCaptured: null,
    
    // ä½œç”¨åŸŸ
    scope: new EffectScope(true)
  }
  
  instance.ctx = { _: instance }
  instance.root = parent ? parent.root : instance
  instance.emit = emit.bind(null, instance)
  
  return instance
}

// è®¾ç½®ç»„ä»¶å®ä¾‹
function setupComponent(instance) {
  const { props, children } = instance.vnode
  const isStateful = isStatefulComponent(instance)
  
  // åˆå§‹åŒ–props
  initProps(instance, props, isStateful)
  
  // åˆå§‹åŒ–slots
  initSlots(instance, children)
  
  // è®¾ç½®æœ‰çŠ¶æ€ç»„ä»¶
  const setupResult = isStateful
    ? setupStatefulComponent(instance)
    : undefined
    
  return setupResult
}

// è®¾ç½®æœ‰çŠ¶æ€ç»„ä»¶
function setupStatefulComponent(instance) {
  const Component = instance.type
  
  // åˆ›å»ºæ¸²æŸ“ä»£ç†
  instance.proxy = new Proxy(instance.ctx, PublicInstanceProxyHandlers)
  
  // è°ƒç”¨setupå‡½æ•°
  const { setup } = Component
  if (setup) {
    const setupContext = createSetupContext(instance)
    setCurrentInstance(instance)
    
    const setupResult = callWithErrorHandling(
      setup,
      instance,
      [instance.props, setupContext]
    )
    
    setCurrentInstance(null)
    
    if (isPromise(setupResult)) {
      // å¼‚æ­¥ç»„ä»¶
      instance.asyncDep = setupResult
    } else {
      handleSetupResult(instance, setupResult)
    }
  } else {
    finishComponentSetup(instance)
  }
}

// å¤„ç†setupç»“æœ
function handleSetupResult(instance, setupResult) {
  if (isFunction(setupResult)) {
    // setupè¿”å›æ¸²æŸ“å‡½æ•°
    instance.render = setupResult
  } else if (isObject(setupResult)) {
    // setupè¿”å›çŠ¶æ€å¯¹è±¡
    instance.setupState = proxyRefs(setupResult)
  }
  
  finishComponentSetup(instance)
}

// å®Œæˆç»„ä»¶è®¾ç½®
function finishComponentSetup(instance) {
  const Component = instance.type
  
  // ç¡®ä¿æœ‰renderå‡½æ•°
  if (!instance.render) {
    if (Component.render) {
      instance.render = Component.render
    } else if (Component.template) {
      // ç¼–è¯‘æ¨¡æ¿ä¸ºrenderå‡½æ•°
      instance.render = compile(Component.template)
    }
  }
  
  // åº”ç”¨é€‰é¡¹API
  applyOptions(instance)
}

// è®¾ç½®æ¸²æŸ“å‰¯ä½œç”¨
function setupRenderEffect(instance, initialVNode, container, anchor) {
  const componentUpdateFn = () => {
    if (!instance.isMounted) {
      // æŒ‚è½½é˜¶æ®µ
      let vnodeHook
      const { el, props } = initialVNode
      const { bm, m, parent } = instance
      
      // beforeMounté’©å­
      if (bm) {
        invokeArrayFns(bm)
      }
      
      // onVnodeBeforeMounté’©å­
      if ((vnodeHook = props && props.onVnodeBeforeMount)) {
        invokeVNodeHook(vnodeHook, parent, initialVNode)
      }
      
      // æ¸²æŸ“å­æ ‘
      const subTree = instance.subTree = renderComponentRoot(instance)
      
      // patchå­æ ‘
      patch(null, subTree, container, anchor)
      
      // ä¿å­˜æ ¹DOMèŠ‚ç‚¹
      initialVNode.el = subTree.el
      
      // mountedé’©å­
      if (m) {
        queuePostRenderEffect(m, instance.scope)
      }
      
      // onVnodeMountedé’©å­
      if ((vnodeHook = props && props.onVnodeMounted)) {
        const scopedNext = initialVNode
        queuePostRenderEffect(
          () => invokeVNodeHook(vnodeHook, parent, scopedNext),
          instance.scope
        )
      }
      
      instance.isMounted = true
    } else {
      // æ›´æ–°é˜¶æ®µ
      let { next, bu, u, parent, vnode } = instance
      let originNext = next
      let vnodeHook
      
      if (next) {
        next.el = vnode.el
        updateComponentPreRender(instance, next, optimized)
      } else {
        next = vnode
      }
      
      // beforeUpdateé’©å­
      if (bu) {
        invokeArrayFns(bu)
      }
      
      // onVnodeBeforeUpdateé’©å­
      if ((vnodeHook = next.props && next.props.onVnodeBeforeUpdate)) {
        invokeVNodeHook(vnodeHook, parent, next, vnode)
      }
      
      // æ¸²æŸ“æ–°çš„å­æ ‘
      const nextTree = renderComponentRoot(instance)
      const prevTree = instance.subTree
      instance.subTree = nextTree
      
      // patchæ–°æ—§å­æ ‘
      patch(prevTree, nextTree, hostParentNode(prevTree.el), getNextHostNode(prevTree))
      
      // æ›´æ–°æ ¹DOMèŠ‚ç‚¹å¼•ç”¨
      next.el = nextTree.el
      
      if (originNext === null) {
        updateHOCHostEl(instance, nextTree.el)
      }
      
      // updatedé’©å­
      if (u) {
        queuePostRenderEffect(u, instance.scope)
      }
      
      // onVnodeUpdatedé’©å­
      if ((vnodeHook = next.props && next.props.onVnodeUpdated)) {
        queuePostRenderEffect(
          () => invokeVNodeHook(vnodeHook, parent, next, vnode),
          instance.scope
        )
      }
    }
  }
  
  // åˆ›å»ºå“åº”å¼å‰¯ä½œç”¨
  const effect = instance.effect = new ReactiveEffect(
    componentUpdateFn,
    () => queueJob(instance.update),
    instance.scope
  )
  
  const update = instance.update = effect.run.bind(effect)
  update.id = instance.uid
  
  // å…è®¸é€’å½’æ›´æ–°
  toggleRecurse(instance, true)
  
  // é¦–æ¬¡è¿è¡Œ
  update()
}

// æ›´æ–°ç»„ä»¶
function updateComponent(n1, n2) {
  const instance = n2.component = n1.component
  if (shouldUpdateComponent(n1, n2)) {
    instance.next = n2
    invalidateJob(instance.update)
    instance.update()
  } else {
    n2.component = n1.component
    n2.el = n1.el
    instance.vnode = n2
  }
}

// æ¸²æŸ“ç»„ä»¶æ ¹èŠ‚ç‚¹
function renderComponentRoot(instance) {
  const {
    type: Component,
    vnode,
    proxy,
    withProxy,
    props,
    propsOptions: [propsOptions],
    slots,
    attrs,
    emit,
    render,
    renderCache,
    data,
    setupState,
    ctx
  } = instance
  
  let result
  const proxyToUse = withProxy || proxy
  
  try {
    if (vnode.shapeFlag & ShapeFlags.STATEFUL_COMPONENT) {
      // æœ‰çŠ¶æ€ç»„ä»¶
      result = normalizeVNode(
        render.call(
          proxyToUse,
          proxyToUse,
          renderCache,
          props,
          setupState,
          data,
          ctx
        )
      )
    } else {
      // å‡½æ•°ç»„ä»¶
      result = normalizeVNode(
        Component(
          props,
          { attrs, slots, emit }
        )
      )
    }
  } catch (err) {
    handleError(err, instance, ErrorCodes.RENDER_FUNCTION)
    result = createVNode(Comment, null, 'render error')
  }
  
  return result
}
```

**ç»„ä»¶æ¸²æŸ“çš„å…³é”®ç‰¹æ€§ï¼š**

1. **å“åº”å¼é›†æˆ**ï¼šé€šè¿‡ReactiveEffectå°†ç»„ä»¶æ¸²æŸ“ä¸å“åº”å¼ç³»ç»Ÿç»“åˆ
2. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šåœ¨é€‚å½“çš„æ—¶æœºè°ƒç”¨å„ç§ç”Ÿå‘½å‘¨æœŸé’©å­
3. **é”™è¯¯è¾¹ç•Œ**ï¼šæ•è·å’Œå¤„ç†æ¸²æŸ“è¿‡ç¨‹ä¸­çš„é”™è¯¯
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡shouldUpdateComponenté¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
5. **å¼‚æ­¥æ›´æ–°**ï¼šä½¿ç”¨è°ƒåº¦å™¨å®ç°å¼‚æ­¥æ‰¹é‡æ›´æ–°

**ç»„ä»¶æ›´æ–°çš„ä¼˜åŒ–ç­–ç•¥ï¼š**

1. **Propsæ¯”è¾ƒ**ï¼šåªæœ‰propså‘ç”Ÿå˜åŒ–æ—¶æ‰æ›´æ–°ç»„ä»¶
2. **æµ…æ¯”è¾ƒ**ï¼šå¯¹propsè¿›è¡Œæµ…æ¯”è¾ƒï¼Œé¿å…æ·±åº¦æ¯”è¾ƒçš„æ€§èƒ½å¼€é”€
3. **ç¼“å­˜ä¼˜åŒ–**ï¼šç¼“å­˜æ¸²æŸ“ç»“æœå’Œè®¡ç®—å±æ€§
4. **å¼‚æ­¥è°ƒåº¦**ï¼šå°†æ›´æ–°ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œæ‰¹é‡æ‰§è¡Œ

### é—®é¢˜6ï¼šå¦‚ä½•å®ç°æ¸²æŸ“ä¼˜åŒ–ï¼Ÿ
**å­¦ä¹ é‡ç‚¹ï¼š**
- é™æ€æå‡çš„è¿è¡Œæ—¶ä½“ç°
- patch flagsçš„ä½¿ç”¨
- å—çº§æ›´æ–°ä¼˜åŒ–

**ğŸ“‹ è¯¦ç»†è§£ç­”ï¼š**

**é™æ€æå‡çš„è¿è¡Œæ—¶ä½“ç°ï¼š**

é™æ€æå‡æ˜¯ç¼–è¯‘æ—¶ä¼˜åŒ–ï¼Œå°†ä¸ä¼šå˜åŒ–çš„VNodeæå‡åˆ°æ¸²æŸ“å‡½æ•°å¤–éƒ¨ï¼Œé¿å…é‡å¤åˆ›å»ºï¼š

```javascript
// ç¼–è¯‘å‰çš„æ¨¡æ¿
// <div>
//   <h1>Static Title</h1>
//   <p>{{ message }}</p>
// </div>

// ç¼–è¯‘åçš„ä»£ç ï¼ˆé™æ€æå‡ï¼‰
const _hoisted_1 = createVNode("h1", null, "Static Title")

function render(_ctx) {
  return createVNode("div", null, [
    _hoisted_1, // é™æ€èŠ‚ç‚¹è¢«æå‡ï¼Œä¸ä¼šé‡å¤åˆ›å»º
    createVNode("p", null, _ctx.message, 1 /* TEXT */)
  ])
}
```

**patch flagsçš„ä½¿ç”¨ï¼š**

Patch flagsæ˜¯ç¼–è¯‘æ—¶ç”Ÿæˆçš„æ ‡è®°ï¼ŒæŒ‡ç¤ºVNodeçš„å“ªäº›éƒ¨åˆ†æ˜¯åŠ¨æ€çš„ï¼Œè¿è¡Œæ—¶å¯ä»¥è¿›è¡Œé’ˆå¯¹æ€§æ›´æ–°ï¼š

**å—çº§æ›´æ–°ä¼˜åŒ–ï¼š**

å—çº§æ›´æ–°é€šè¿‡æ”¶é›†åŠ¨æ€èŠ‚ç‚¹ï¼Œè·³è¿‡é™æ€èŠ‚ç‚¹çš„éå†ï¼Œå®ç°ç²¾ç¡®æ›´æ–°ï¼š

**ğŸ“‹ è¯¦ç»†è§£ç­”ï¼š**

**é™æ€æå‡çš„è¿è¡Œæ—¶ä½“ç°ï¼š**

é™æ€æå‡æ˜¯ç¼–è¯‘æ—¶ä¼˜åŒ–ï¼Œå°†ä¸ä¼šå˜åŒ–çš„VNodeæå‡åˆ°æ¸²æŸ“å‡½æ•°å¤–éƒ¨ï¼Œé¿å…é‡å¤åˆ›å»ºï¼š

```javascript
// ç¼–è¯‘å‰çš„æ¨¡æ¿
// <div>
//   <h1>Static Title</h1>
//   <p>{{ message }}</p>
// </div>

// ç¼–è¯‘åçš„ä»£ç ï¼ˆé™æ€æå‡ï¼‰
const _hoisted_1 = createVNode("h1", null, "Static Title")

function render(_ctx) {
  return createVNode("div", null, [
    _hoisted_1, // é™æ€èŠ‚ç‚¹è¢«æå‡ï¼Œä¸ä¼šé‡å¤åˆ›å»º
    createVNode("p", null, _ctx.message, 1 /* TEXT */)
  ])
}
```

**patch flagsçš„ä½¿ç”¨ï¼š**

Patch flagsæ˜¯ç¼–è¯‘æ—¶ç”Ÿæˆçš„æ ‡è®°ï¼ŒæŒ‡ç¤ºVNodeçš„å“ªäº›éƒ¨åˆ†æ˜¯åŠ¨æ€çš„ï¼Œè¿è¡Œæ—¶å¯ä»¥è¿›è¡Œé’ˆå¯¹æ€§æ›´æ–°ï¼š

**å—çº§æ›´æ–°ä¼˜åŒ–ï¼š**

å—çº§æ›´æ–°é€šè¿‡æ”¶é›†åŠ¨æ€èŠ‚ç‚¹ï¼Œè·³è¿‡é™æ€èŠ‚ç‚¹çš„éå†ï¼Œå®ç°ç²¾ç¡®æ›´æ–°ï¼š

**å®è·µä»»åŠ¡ï¼š**
```javascript
// å®Œæ•´çš„patch flagså®šä¹‰å’Œä½¿ç”¨
const PatchFlags = {
  TEXT: 1,                    // åŠ¨æ€æ–‡æœ¬å†…å®¹
  CLASS: 2,                   // åŠ¨æ€class
  STYLE: 4,                   // åŠ¨æ€style
  PROPS: 8,                   // åŠ¨æ€propsï¼ˆé™¤äº†classå’Œstyleï¼‰
  FULL_PROPS: 16,             // æœ‰keyï¼Œéœ€è¦å®Œæ•´diff
  HYDRATE_EVENTS: 32,         // æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼ˆä»…ç”¨äºhydrationï¼‰
  STABLE_FRAGMENT: 64,        // ç¨³å®šåºåˆ—ï¼Œå­èŠ‚ç‚¹é¡ºåºä¸ä¼šæ”¹å˜
  KEYED_FRAGMENT: 128,        // æœ‰keyçš„fragment
  UNKEYED_FRAGMENT: 256,      // æ— keyçš„fragment
  NEED_PATCH: 512,            // åªéœ€è¦épropsçš„patch
  DYNAMIC_SLOTS: 1024,        // åŠ¨æ€æ’æ§½
  DEV_ROOT_FRAGMENT: 2048,    // å¼€å‘æ¨¡å¼ä¸‹çš„æ ¹fragment
  HOISTED: -1,                // é™æ€æå‡çš„èŠ‚ç‚¹ï¼Œæ°¸è¿œä¸ä¼šå˜åŒ–
  BAIL: -2                    // diffç®—æ³•è¦é€€å›åˆ°æœ€æ…¢çš„
}

// ä¼˜åŒ–çš„å…ƒç´ patchå‡½æ•°
function patchElement(n1, n2, parentComponent, parentSuspense, isSVG, slotScopeIds, optimized) {
  const el = n2.el = n1.el
  let { patchFlag, dynamicChildren, dirs } = n2
  
  // åˆå¹¶æ—§èŠ‚ç‚¹çš„patchFlagï¼ˆç”¨äºå¼€å‘æ¨¡å¼çš„HMRï¼‰
  patchFlag |= n1.patchFlag & PatchFlags.FULL_PROPS
  
  const oldProps = n1.props || EMPTY_OBJ
  const newProps = n2.props || EMPTY_OBJ
  
  let vnodeHook
  
  // ç¦ç”¨é€’å½’ä»¥é¿å…åœ¨hooksä¸­è§¦å‘æ›´æ–°
  parentComponent && toggleRecurse(parentComponent, false)
  
  if ((vnodeHook = newProps.onVnodeBeforeUpdate)) {
    invokeVNodeHook(vnodeHook, parentComponent, n2, n1)
  }
  
  if (dirs) {
    invokeDirectiveHook(n2, n1, parentComponent, 'beforeUpdate')
  }
  
  parentComponent && toggleRecurse(parentComponent, true)
  
  // æ ¹æ®patchFlagè¿›è¡Œä¼˜åŒ–æ›´æ–°
  if (patchFlag > 0) {
    // æœ‰åŠ¨æ€å†…å®¹ï¼Œè¿›è¡Œé’ˆå¯¹æ€§æ›´æ–°
    if (patchFlag & PatchFlags.FULL_PROPS) {
      // éœ€è¦å®Œæ•´çš„props diff
      patchProps(
        el,
        n2,
        oldProps,
        newProps,
        parentComponent,
        parentSuspense,
        isSVG
      )
    } else {
      // é’ˆå¯¹æ€§æ›´æ–°
      if (patchFlag & PatchFlags.CLASS) {
        if (oldProps.class !== newProps.class) {
          hostPatchProp(el, 'class', null, newProps.class, isSVG)
        }
      }
      
      if (patchFlag & PatchFlags.STYLE) {
        hostPatchProp(el, 'style', oldProps.style, newProps.style, isSVG)
      }
      
      if (patchFlag & PatchFlags.PROPS) {
        // åªæ›´æ–°åŠ¨æ€props
        const propsToUpdate = n2.dynamicProps
        for (let i = 0; i < propsToUpdate.length; i++) {
          const key = propsToUpdate[i]
          const prev = oldProps[key]
          const next = newProps[key]
          if (next !== prev || key === 'value') {
            hostPatchProp(
              el,
              key,
              prev,
              next,
              isSVG,
              n1.children,
              parentComponent,
              parentSuspense,
              unmountChildren
            )
          }
        }
      }
    }
    
    if (patchFlag & PatchFlags.TEXT) {
      if (n1.children !== n2.children) {
        hostSetElementText(el, n2.children)
      }
    }
  } else if (!optimized && dynamicChildren == null) {
    // æ²¡æœ‰ä¼˜åŒ–æ ‡è®°ï¼Œè¿›è¡Œå®Œæ•´propsæ›´æ–°
    patchProps(
      el,
      n2,
      oldProps,
      newProps,
      parentComponent,
      parentSuspense,
      isSVG
    )
  }
  
  // æ›´æ–°å­èŠ‚ç‚¹
  if ((patchFlag & PatchFlags.ARRAY_CHILDREN) && dynamicChildren) {
    // å—çº§æ›´æ–°ï¼šåªæ›´æ–°åŠ¨æ€å­èŠ‚ç‚¹
    patchBlockChildren(
      n1.dynamicChildren,
      dynamicChildren,
      el,
      parentComponent,
      parentSuspense,
      isSVG,
      slotScopeIds
    )
  } else {
    // å®Œæ•´çš„å­èŠ‚ç‚¹diff
    patchChildren(
      n1,
      n2,
      el,
      null,
      parentComponent,
      parentSuspense,
      isSVG,
      slotScopeIds,
      optimized
    )
  }
  
  if ((vnodeHook = newProps.onVnodeUpdated) || dirs) {
    queuePostRenderEffect(() => {
      vnodeHook && invokeVNodeHook(vnodeHook, parentComponent, n2, n1)
      dirs && invokeDirectiveHook(n2, n1, parentComponent, 'updated')
    }, parentSuspense)
  }
}

// å—çº§å­èŠ‚ç‚¹æ›´æ–°
function patchBlockChildren(
  oldChildren,
  newChildren,
  fallbackContainer,
  parentComponent,
  parentSuspense,
  isSVG,
  slotScopeIds
) {
  for (let i = 0; i < newChildren.length; i++) {
    const oldVNode = oldChildren[i]
    const newVNode = newChildren[i]
    // ç¡®å®špatchçš„å®¹å™¨
    const container =
      // oldVNodeå¯èƒ½æ˜¯Fragmentï¼Œéœ€è¦æ‰¾åˆ°æ­£ç¡®çš„çˆ¶å®¹å™¨
      oldVNode.el &&
      (oldVNode.type === Fragment ||
        !isSameVNodeType(oldVNode, newVNode) ||
        oldVNode.shapeFlag & ShapeFlags.COMPONENT ||
        oldVNode.shapeFlag & ShapeFlags.TELEPORT)
        ? hostParentNode(oldVNode.el)
        : fallbackContainer
    
    patch(
      oldVNode,
      newVNode,
      container,
      null,
      parentComponent,
      parentSuspense,
      isSVG,
      slotScopeIds,
      true
    )
  }
}

// åˆ›å»ºå—çº§VNode
function createBlock(type, props, children, patchFlag, dynamicProps) {
  return setupBlock(
    createVNode(
      type,
      props,
      children,
      patchFlag,
      dynamicProps,
      true /* isBlock */
    )
  )
}

// è®¾ç½®å—çº§VNode
function setupBlock(vnode) {
  // æ”¶é›†å½“å‰å—ä¸­çš„åŠ¨æ€å­èŠ‚ç‚¹
  vnode.dynamicChildren = isBlockTreeEnabled > 0 ? currentBlock || EMPTY_ARR : null
  // å…³é—­å½“å‰å—
  closeBlock()
  // å¦‚æœå½“å‰æ­£åœ¨è·Ÿè¸ªï¼Œå°†æ­¤å—æ·»åŠ åˆ°çˆ¶å—ä¸­
  if (isBlockTreeEnabled > 0 && currentBlock) {
    currentBlock.push(vnode)
  }
  return vnode
}

// æ‰“å¼€å—çº§è·Ÿè¸ª
function openBlock(disableTracking = false) {
  blockStack.push((currentBlock = disableTracking ? null : []))
}

// å…³é—­å—çº§è·Ÿè¸ª
function closeBlock() {
  blockStack.pop()
  currentBlock = blockStack[blockStack.length - 1] || null
}

// è·Ÿè¸ªåŠ¨æ€èŠ‚ç‚¹
function trackDynamicNode(vnode) {
  if (isBlockTreeEnabled > 0 && currentBlock) {
    currentBlock.push(vnode)
  }
}

// ç¼–è¯‘æ—¶ç”Ÿæˆçš„ä¼˜åŒ–ä»£ç ç¤ºä¾‹
function optimizedRender(_ctx) {
  return (openBlock(), createBlock('div', null, [
    createVNode('h1', null, 'Static Title'), // é™æ€èŠ‚ç‚¹
    createVNode('p', null, _ctx.message, 1 /* TEXT */), // åŠ¨æ€æ–‡æœ¬
    createVNode('button', {
      class: _ctx.buttonClass,
      onClick: _ctx.handleClick
    }, 'Click me', 10 /* CLASS, PROPS */, ['class', 'onClick']) // åŠ¨æ€classå’Œprops
  ]))
}
```

**æ¸²æŸ“ä¼˜åŒ–çš„æ ¸å¿ƒç­–ç•¥ï¼š**

1. **ç¼–è¯‘æ—¶ä¼˜åŒ–**ï¼š
   - **é™æ€æå‡**ï¼šæå‡é™æ€èŠ‚ç‚¹ï¼Œé¿å…é‡å¤åˆ›å»º
   - **Patch flags**ï¼šæ ‡è®°åŠ¨æ€å†…å®¹ï¼Œå®ç°ç²¾ç¡®æ›´æ–°
   - **å†…è”ç»„ä»¶props**ï¼šä¼˜åŒ–ç»„ä»¶propsçš„ä¼ é€’
   - **æ­»ä»£ç æ¶ˆé™¤**ï¼šç§»é™¤æœªä½¿ç”¨çš„ä»£ç 

2. **è¿è¡Œæ—¶ä¼˜åŒ–**ï¼š
   - **å—çº§æ›´æ–°**ï¼šåªéå†åŠ¨æ€èŠ‚ç‚¹ï¼Œè·³è¿‡é™æ€èŠ‚ç‚¹
   - **é¶å‘æ›´æ–°**ï¼šæ ¹æ®patch flagsè¿›è¡Œé’ˆå¯¹æ€§æ›´æ–°
   - **ç¼“å­˜ä¼˜åŒ–**ï¼šç¼“å­˜äº‹ä»¶å¤„ç†å™¨å’Œè®¡ç®—ç»“æœ
   - **å¼‚æ­¥è°ƒåº¦**ï¼šæ‰¹é‡æ›´æ–°ï¼Œé¿å…é‡å¤æ¸²æŸ“

3. **å†…å­˜ä¼˜åŒ–**ï¼š
   - **å¯¹è±¡å¤ç”¨**ï¼šå¤ç”¨VNodeå¯¹è±¡
   - **å¼±å¼•ç”¨**ï¼šé¿å…å†…å­˜æ³„æ¼
   - **åŠæ—¶æ¸…ç†**ï¼šæ¸…ç†ä¸å†éœ€è¦çš„å¼•ç”¨

**æ€§èƒ½æå‡æ•ˆæœï¼š**

1. **æ›´æ–°æ€§èƒ½**ï¼šé€šè¿‡patch flagsï¼Œæ›´æ–°æ€§èƒ½æå‡2-3å€
2. **å†…å­˜ä½¿ç”¨**ï¼šé€šè¿‡é™æ€æå‡ï¼Œå‡å°‘50%çš„VNodeåˆ›å»º
3. **åŒ…ä½“ç§¯**ï¼šé€šè¿‡Tree-shakingï¼Œå‡å°‘ä¸å¿…è¦çš„ä»£ç 
4. **é¦–å±æ¸²æŸ“**ï¼šé€šè¿‡ç¼–è¯‘ä¼˜åŒ–ï¼Œæå‡é¦–å±æ¸²æŸ“é€Ÿåº¦

**æœ€ä½³å®è·µå»ºè®®ï¼š**

1. **åˆç†ä½¿ç”¨key**ï¼šä¸ºåˆ—è¡¨é¡¹æä¾›ç¨³å®šçš„key
2. **é¿å…å†…è”å¯¹è±¡**ï¼šé¿å…åœ¨æ¨¡æ¿ä¸­åˆ›å»ºå†…è”å¯¹è±¡å’Œå‡½æ•°
3. **ä½¿ç”¨v-memo**ï¼šå¯¹å¤æ‚çš„å­æ ‘è¿›è¡Œè®°å¿†åŒ–
4. **ç»„ä»¶æ‹†åˆ†**ï¼šå°†å¤§ç»„ä»¶æ‹†åˆ†ä¸ºå°ç»„ä»¶ï¼Œæé«˜æ›´æ–°ç²¾åº¦
5. **å¼‚æ­¥ç»„ä»¶**ï¼šä½¿ç”¨å¼‚æ­¥ç»„ä»¶è¿›è¡Œä»£ç åˆ†å‰²

## ğŸ“– ç†è®ºå­¦ä¹ èµ„æº

### Vue 3å®˜æ–¹æ–‡æ¡£
- [æ¸²æŸ“æœºåˆ¶](https://cn.vuejs.org/guide/extras/rendering-mechanism.html)
- [æ¸²æŸ“å‡½æ•°API](https://cn.vuejs.org/guide/extras/render-function.html)

### æ¨èé˜…è¯»æºç ä½ç½®
```
vue-next/packages/runtime-core/src/
â”œâ”€â”€ renderer.ts         # æ¸²æŸ“å™¨æ ¸å¿ƒ
â”œâ”€â”€ vnode.ts           # è™šæ‹ŸDOMå®šä¹‰
â”œâ”€â”€ component.ts       # ç»„ä»¶å¤„ç†
â”œâ”€â”€ componentRenderUtils.ts # ç»„ä»¶æ¸²æŸ“å·¥å…·
â””â”€â”€ hydration.ts       # æœåŠ¡ç«¯æ¸²æŸ“æ°´åˆ

vue-next/packages/runtime-dom/src/
â”œâ”€â”€ index.ts           # DOMç›¸å…³æ¸²æŸ“å™¨
â”œâ”€â”€ nodeOps.ts         # DOMæ“ä½œ
â””â”€â”€ patchProp.ts       # å±æ€§æ›´æ–°
```

### å…³é”®æ¦‚å¿µæ¢³ç†
1. **è™šæ‹ŸDOM** - ç”¨JavaScriptå¯¹è±¡æè¿°DOMç»“æ„
2. **æ¸²æŸ“å™¨** - å°†è™šæ‹ŸDOMè½¬æ¢ä¸ºçœŸå®DOMçš„å·¥å…·
3. **diffç®—æ³•** - æ¯”è¾ƒæ–°æ—§è™šæ‹ŸDOMæ ‘ï¼Œæ‰¾å‡ºå˜åŒ–
4. **patch** - å°†å˜åŒ–åº”ç”¨åˆ°çœŸå®DOMçš„è¿‡ç¨‹

## ğŸ› ï¸ å®è·µä»»åŠ¡æ¸…å•

- [ ] è®¾è®¡å¹¶å®ç°VNodeæ•°æ®ç»“æ„
- [ ] å®ç°åŸºç¡€çš„renderå‡½æ•°
- [ ] å®ç°mountæŒ‚è½½é€»è¾‘
- [ ] å®ç°ç®€å•çš„diffç®—æ³•  
- [ ] å®ç°åˆ—è¡¨çš„é«˜æ•ˆdiffï¼ˆåŒç«¯+LISï¼‰
- [ ] å¤„ç†ç»„ä»¶çš„æ¸²æŸ“æµç¨‹
- [ ] å®ç°patch flagsä¼˜åŒ–
- [ ] å®ç°äº‹ä»¶ç³»ç»Ÿ
- [ ] å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ
- [ ] ç¼–å†™æ€§èƒ½æµ‹è¯•ç”¨ä¾‹

## ğŸ”¬ æºç ç ”è¯»é‡ç‚¹

### 1. renderer.tsä¸­çš„baseCreateRendererå‡½æ•°
```typescript
// æ€è€ƒé—®é¢˜ï¼š
// 1. æ¸²æŸ“å™¨æ˜¯å¦‚ä½•è®¾è®¡æˆå¹³å°æ— å…³çš„ï¼Ÿ
// 2. nodeOpså’ŒpatchPropæ˜¯å¦‚ä½•æŠ½è±¡DOMæ“ä½œçš„ï¼Ÿ
// 3. å¦‚ä½•å¤„ç†ä¸åŒç±»å‹çš„èŠ‚ç‚¹ï¼Ÿ
```

### 2. åŒç«¯diffç®—æ³•çš„å®ç°
```typescript
// æ€è€ƒé—®é¢˜ï¼š
// 1. ä¸ºä»€ä¹ˆè¦ä»ä¸¤ç«¯å¼€å§‹æ¯”è¾ƒï¼Ÿ
// 2. æœ€é•¿é€’å¢å­åºåˆ—ç®—æ³•çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
// 3. å¦‚ä½•è®¡ç®—æœ€å°çš„ç§»åŠ¨æ¬¡æ•°ï¼Ÿ
```

### 3. ç»„ä»¶æ¸²æŸ“çš„setupRenderEffectå‡½æ•°
```typescript
// æ€è€ƒé—®é¢˜ï¼š
// 1. ç»„ä»¶å¦‚ä½•ä¸å“åº”å¼ç³»ç»Ÿé›†æˆï¼Ÿ
// 2. å¦‚ä½•é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“ï¼Ÿ
// 3. ç»„ä»¶æ›´æ–°çš„è°ƒåº¦æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
```

## âœ… å­¦ä¹ æˆæœæ£€éªŒ

å®Œæˆæœ¬é˜¶æ®µå­¦ä¹ åï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

1. **ç†è®ºç†è§£**
   - [ ] ç†è§£è™šæ‹ŸDOMçš„è®¾è®¡æ€æƒ³å’Œä¼˜åŠ¿
   - [ ] æŒæ¡diffç®—æ³•çš„æ ¸å¿ƒåŸç†
   - [ ] ç†è§£æ¸²æŸ“å™¨çš„æ•´ä½“æ¶æ„

2. **å®è·µèƒ½åŠ›**
   - [ ] ç‹¬ç«‹å®ç°ä¸€ä¸ªåŸºç¡€çš„æ¸²æŸ“å™¨
   - [ ] å®ç°é«˜æ•ˆçš„åˆ—è¡¨diffç®—æ³•
   - [ ] å¤„ç†ç»„ä»¶æ¸²æŸ“çš„å®Œæ•´æµç¨‹

3. **æºç ç†è§£**
   - [ ] èƒ½å¤Ÿé˜…è¯»Vue 3æ¸²æŸ“å™¨ç›¸å…³æºç 
   - [ ] ç†è§£å„ç§æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥
   - [ ] æŒæ¡ç»„ä»¶ç³»ç»Ÿçš„å®ç°ç»†èŠ‚

## ğŸ¯ è¿›é˜¶æ€è€ƒé¢˜

### 1. ä¸ºä»€ä¹ˆVue 3é€‰æ‹©åŒç«¯diff + æœ€é•¿é€’å¢å­åºåˆ—çš„ç®—æ³•ï¼Ÿ
**æ€è€ƒæ–¹å‘ï¼š**
- ä¸Reactçš„diffç®—æ³•å¯¹æ¯”
- æ—¶é—´å¤æ‚åº¦åˆ†æ
- å®é™…åœºæ™¯çš„æ€§èƒ½è¡¨ç°

**ğŸ“‹ è¯¦ç»†è§£ç­”ï¼š**

**ç®—æ³•é€‰æ‹©çš„åŸå› ï¼š**

1. **åŒç«¯å¯¹æ¯”çš„ä¼˜åŠ¿**ï¼š
   - **å¸¸è§åœºæ™¯ä¼˜åŒ–**ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼Œåˆ—è¡¨çš„å˜åŒ–å¾€å¾€å‘ç”Ÿåœ¨å¤´éƒ¨æˆ–å°¾éƒ¨ï¼ˆå¦‚æ·»åŠ æ–°é¡¹ã€åˆ é™¤æ—§é¡¹ï¼‰
   - **å¿«é€Ÿè·¯å¾„**ï¼šåŒç«¯å¯¹æ¯”å¯ä»¥å¿«é€Ÿå¤„ç†è¿™äº›å¸¸è§æƒ…å†µï¼Œé¿å…å¤æ‚çš„ä¸­é—´å¤„ç†
   - **å‡å°‘ç§»åŠ¨æ“ä½œ**ï¼šé€šè¿‡å¤´å°¾å¯¹æ¯”ï¼Œå¯ä»¥æœ€å¤§åŒ–åœ°å¤ç”¨ç°æœ‰èŠ‚ç‚¹

2. **æœ€é•¿é€’å¢å­åºåˆ—(LIS)çš„ä½œç”¨**ï¼š
   - **æœ€å°åŒ–DOMæ“ä½œ**ï¼šLISç®—æ³•æ‰¾å‡ºä¸éœ€è¦ç§»åŠ¨çš„æœ€é•¿ç¨³å®šåºåˆ—
   - **ä¼˜åŒ–ç§»åŠ¨ç­–ç•¥**ï¼šåªç§»åŠ¨LISä¹‹å¤–çš„èŠ‚ç‚¹ï¼Œå‡å°‘DOMæ“ä½œæ¬¡æ•°
   - **æ•°å­¦æœ€ä¼˜è§£**ï¼šä»ç†è®ºä¸Šä¿è¯äº†ç§»åŠ¨æ“ä½œçš„æœ€å°‘åŒ–

**ä¸React diffç®—æ³•çš„å¯¹æ¯”ï¼š**

```javascript
// Reactçš„diffç­–ç•¥ï¼ˆç®€åŒ–ï¼‰
// 1. åªå¯¹æ¯”åŒå±‚çº§èŠ‚ç‚¹
// 2. é€šè¿‡keyè¯†åˆ«èŠ‚ç‚¹
// 3. ä½¿ç”¨å¯å‘å¼ç®—æ³•ï¼Œæ—¶é—´å¤æ‚åº¦O(n)
// ä½†åœ¨æŸäº›åœºæ™¯ä¸‹å¯èƒ½äº§ç”Ÿè¾ƒå¤šçš„DOMæ“ä½œ

// Vue 3çš„diffç­–ç•¥
// 1. åŒç«¯å¯¹æ¯” + LISç®—æ³•
// 2. é¢„å¤„ç†å¸¸è§åœºæ™¯
// 3. æœ€å°åŒ–DOMç§»åŠ¨æ“ä½œ
// åœ¨å¤§å¤šæ•°å®é™…åœºæ™¯ä¸­æ€§èƒ½æ›´ä¼˜
```

**æ—¶é—´å¤æ‚åº¦åˆ†æï¼š**

- **æœ€å¥½æƒ…å†µ**ï¼šO(n) - å½“å˜åŒ–åªåœ¨å¤´éƒ¨æˆ–å°¾éƒ¨æ—¶
- **å¹³å‡æƒ…å†µ**ï¼šO(n log n) - éœ€è¦è®¡ç®—LISæ—¶
- **æœ€åæƒ…å†µ**ï¼šO(nÂ²) - æç«¯æƒ…å†µä¸‹é€€åŒ–ä¸ºæš´åŠ›æ¯”è¾ƒ

**å®é™…æ€§èƒ½è¡¨ç°ï¼š**

åœ¨å¤§å¤šæ•°çœŸå®åœºæ™¯ä¸­ï¼ŒVue 3çš„ç®—æ³•æ¯”ä¼ ç»Ÿç®—æ³•æ€§èƒ½æå‡20-40%ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§åˆ—è¡¨æ›´æ–°æ—¶æ•ˆæœæ˜¾è‘—ã€‚

### 2. patch flagsæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿç¼–è¯‘æ—¶å¦‚ä½•ç”Ÿæˆè¿™äº›æ ‡è®°ï¼Ÿ
**æ€è€ƒæ–¹å‘ï¼š**
- ç¼–è¯‘å™¨çš„é™æ€åˆ†æ
- è¿è¡Œæ—¶çš„ä¼˜åŒ–ç­–ç•¥
- ä¸Vue 2çš„å¯¹æ¯”

**ğŸ“‹ è¯¦ç»†è§£ç­”ï¼š**

**ç¼–è¯‘æ—¶ç”Ÿæˆè¿‡ç¨‹ï¼š**

1. **æ¨¡æ¿åˆ†æé˜¶æ®µ**ï¼š
   ```javascript
   // æ¨¡æ¿
   // <div :class="dynamicClass">{{ message }}</div>
   
   // ç¼–è¯‘å™¨åˆ†æï¼š
   // - classæ˜¯åŠ¨æ€çš„ â†’ CLASS flag
   // - æ–‡æœ¬å†…å®¹æ˜¯åŠ¨æ€çš„ â†’ TEXT flag
   // - æ²¡æœ‰å…¶ä»–åŠ¨æ€å±æ€§
   ```

2. **ASTè½¬æ¢é˜¶æ®µ**ï¼š
   ```javascript
   // ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç 
   function render(_ctx) {
     return createVNode("div", {
       class: _ctx.dynamicClass
     }, _ctx.message, 3 /* TEXT | CLASS */)
   }
   ```

**é™æ€åˆ†æçš„å…³é”®æŠ€æœ¯ï¼š**

```javascript
// ç¼–è¯‘å™¨çš„é™æ€åˆ†æé€»è¾‘
function analyzeNode(node) {
  let patchFlag = 0
  const dynamicProps = []
  
  // åˆ†æå±æ€§
  for (const prop of node.props) {
    if (isStaticExp(prop.value)) {
      // é™æ€å±æ€§ï¼Œæ— éœ€æ ‡è®°
      continue
    }
    
    if (prop.name === 'class') {
      patchFlag |= PatchFlags.CLASS
    } else if (prop.name === 'style') {
      patchFlag |= PatchFlags.STYLE
    } else if (isOn(prop.name)) {
      // äº‹ä»¶ç›‘å¬å™¨
      patchFlag |= PatchFlags.HYDRATE_EVENTS
    } else {
      // å…¶ä»–åŠ¨æ€å±æ€§
      patchFlag |= PatchFlags.PROPS
      dynamicProps.push(prop.name)
    }
  }
  
  // åˆ†æå­èŠ‚ç‚¹
  if (hasTextChildren(node)) {
    patchFlag |= PatchFlags.TEXT
  } else if (hasArrayChildren(node)) {
    // åˆ†æå­èŠ‚ç‚¹çš„ç¨³å®šæ€§
    if (isStableFragment(node.children)) {
      patchFlag |= PatchFlags.STABLE_FRAGMENT
    } else if (hasKeyedChildren(node.children)) {
      patchFlag |= PatchFlags.KEYED_FRAGMENT
    } else {
      patchFlag |= PatchFlags.UNKEYED_FRAGMENT
    }
  }
  
  return { patchFlag, dynamicProps }
}
```

**è¿è¡Œæ—¶ä¼˜åŒ–ç­–ç•¥ï¼š**

```javascript
// è¿è¡Œæ—¶æ ¹æ®patch flagsè¿›è¡Œä¼˜åŒ–
function patchElement(n1, n2) {
  const { patchFlag } = n2
  
  if (patchFlag === 0) {
    // é™æ€èŠ‚ç‚¹ï¼Œè·³è¿‡æ›´æ–°
    return
  }
  
  if (patchFlag & PatchFlags.TEXT) {
    // åªæ›´æ–°æ–‡æœ¬å†…å®¹ï¼Œè·³è¿‡å…¶ä»–æ£€æŸ¥
    if (n1.children !== n2.children) {
      hostSetElementText(el, n2.children)
    }
    return
  }
  
  // æ ¹æ®å…·ä½“çš„flagè¿›è¡Œé’ˆå¯¹æ€§æ›´æ–°
  if (patchFlag & PatchFlags.CLASS) {
    patchClass(el, n1.props.class, n2.props.class)
  }
  
  if (patchFlag & PatchFlags.STYLE) {
    patchStyle(el, n1.props.style, n2.props.style)
  }
  
  // ... å…¶ä»–ä¼˜åŒ–
}
```

**ä¸Vue 2çš„å¯¹æ¯”ï¼š**

- **Vue 2**ï¼šè¿è¡Œæ—¶è¿›è¡Œå®Œæ•´çš„å±æ€§å¯¹æ¯”ï¼Œæ— æ³•è·³è¿‡é™æ€å†…å®¹
- **Vue 3**ï¼šç¼–è¯‘æ—¶æ ‡è®°åŠ¨æ€å†…å®¹ï¼Œè¿è¡Œæ—¶ç²¾ç¡®æ›´æ–°ï¼Œæ€§èƒ½æå‡æ˜¾è‘—

### 3. é™æ€æå‡å¯¹æ€§èƒ½çš„å½±å“æœ‰å¤šå¤§ï¼Ÿ
**æ€è€ƒæ–¹å‘ï¼š**
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- åˆ›å»ºVNodeçš„å¼€é”€
- å®é™…é¡¹ç›®ä¸­çš„æ”¶ç›Š

**ğŸ“‹ è¯¦ç»†è§£ç­”ï¼š**

**å†…å­˜ä½¿ç”¨ä¼˜åŒ–ï¼š**

```javascript
// æœªä¼˜åŒ–çš„ä»£ç 
function render(_ctx) {
  return createVNode('div', null, [
    createVNode('h1', null, 'Static Title'), // æ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»º
    createVNode('p', { class: 'static' }, 'Static Content'), // æ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»º
    createVNode('span', null, _ctx.message) // åŠ¨æ€å†…å®¹
  ])
}

// é™æ€æå‡åçš„ä»£ç 
const _hoisted_1 = createVNode('h1', null, 'Static Title')
const _hoisted_2 = createVNode('p', { class: 'static' }, 'Static Content')

function render(_ctx) {
  return createVNode('div', null, [
    _hoisted_1, // å¤ç”¨é™æ€VNode
    _hoisted_2, // å¤ç”¨é™æ€VNode
    createVNode('span', null, _ctx.message) // åªåˆ›å»ºåŠ¨æ€å†…å®¹
  ])
}
```

**æ€§èƒ½æ”¶ç›Šåˆ†æï¼š**

1. **VNodeåˆ›å»ºå¼€é”€**ï¼š
   - å‡å°‘50-80%çš„VNodeåˆ›å»º
   - é™ä½GCå‹åŠ›
   - æå‡æ¸²æŸ“æ€§èƒ½

2. **å†…å­˜ä½¿ç”¨**ï¼š
   - é™æ€VNodeåªåˆ›å»ºä¸€æ¬¡
   - å‡å°‘å†…å­˜åˆ†é…å’Œå›æ”¶
   - æé«˜å†…å­˜åˆ©ç”¨ç‡

3. **å®é™…é¡¹ç›®æ”¶ç›Š**ï¼š
   - é¦–å±æ¸²æŸ“é€Ÿåº¦æå‡15-30%
   - æ›´æ–°æ€§èƒ½æå‡20-40%
   - å†…å­˜ä½¿ç”¨å‡å°‘30-50%

**é™æ€æå‡çš„é™åˆ¶ï¼š**

```javascript
// ä¸èƒ½æå‡çš„æƒ…å†µ
function render(_ctx) {
  return createVNode('div', null, [
    // åŒ…å«åŠ¨æ€ç»‘å®šï¼Œä¸èƒ½æå‡
    createVNode('p', { id: _ctx.dynamicId }, 'Content'),
    
    // åœ¨v-forä¸­ï¼Œä¸èƒ½æå‡
    ..._ctx.list.map(item => 
      createVNode('span', null, item.text)
    )
  ])
}
```

### 4. ç»„ä»¶çš„å¼‚æ­¥æ›´æ–°æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
**æ€è€ƒæ–¹å‘ï¼š**
- æ›´æ–°é˜Ÿåˆ—çš„ç®¡ç†
- å¾®ä»»åŠ¡çš„ä½¿ç”¨
- æ‰¹é‡æ›´æ–°çš„ç­–ç•¥

**ğŸ“‹ è¯¦ç»†è§£ç­”ï¼š**

**æ›´æ–°é˜Ÿåˆ—çš„ç®¡ç†ï¼š**

```javascript
// æ›´æ–°è°ƒåº¦å™¨çš„æ ¸å¿ƒå®ç°
const queue = []
const activePreFlushCbs = []
const activePostFlushCbs = []
let isFlushing = false
let isFlushPending = false

// å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—
function queueJob(job) {
  if (!queue.includes(job)) {
    if (job.id == null) {
      queue.push(job)
    } else {
      // æ ¹æ®idæ’å…¥åˆ°æ­£ç¡®ä½ç½®ï¼Œä¿è¯çˆ¶ç»„ä»¶å…ˆäºå­ç»„ä»¶æ›´æ–°
      queue.splice(findInsertionIndex(job.id), 0, job)
    }
  }
  queueFlush()
}

// è°ƒåº¦åˆ·æ–°
function queueFlush() {
  if (!isFlushing && !isFlushPending) {
    isFlushPending = true
    currentFlushPromise = resolvedPromise.then(flushJobs)
  }
}

// æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
function flushJobs(seen) {
  isFlushPending = false
  isFlushing = true
  
  // æ’åºé˜Ÿåˆ—ï¼Œç¡®ä¿çˆ¶ç»„ä»¶å…ˆäºå­ç»„ä»¶æ›´æ–°
  queue.sort((a, b) => getId(a) - getId(b))
  
  try {
    for (flushIndex = 0; flushIndex < queue.length; flushIndex++) {
      const job = queue[flushIndex]
      if (job && job.active !== false) {
        callWithErrorHandling(job, null, ErrorCodes.SCHEDULER)
      }
    }
  } finally {
    flushIndex = 0
    queue.length = 0
    
    flushPostFlushCbs(seen)
    
    isFlushing = false
    currentFlushPromise = null
    
    // å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åˆæœ‰æ–°çš„ä»»åŠ¡ï¼Œé€’å½’æ‰§è¡Œ
    if (queue.length || pendingPreFlushCbs.length || pendingPostFlushCbs.length) {
      flushJobs(seen)
    }
  }
}
```

**å¾®ä»»åŠ¡çš„ä½¿ç”¨ï¼š**

```javascript
// ä½¿ç”¨Promise.resolve()åˆ›å»ºå¾®ä»»åŠ¡
const resolvedPromise = Promise.resolve()

// åœ¨ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡ä¸­æ‰§è¡Œæ›´æ–°
function nextTick(fn) {
  const p = currentFlushPromise || resolvedPromise
  return fn ? p.then(this ? fn.bind(this) : fn) : p
}
```

**æ‰¹é‡æ›´æ–°çš„ç­–ç•¥ï¼š**

1. **åŒæ­¥æ”¶é›†**ï¼šåœ¨åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­æ”¶é›†æ‰€æœ‰æ›´æ–°ä»»åŠ¡
2. **å¼‚æ­¥æ‰§è¡Œ**ï¼šåœ¨å¾®ä»»åŠ¡ä¸­æ‰¹é‡æ‰§è¡Œæ›´æ–°
3. **å»é‡ä¼˜åŒ–**ï¼šç›¸åŒç»„ä»¶çš„å¤šæ¬¡æ›´æ–°ä¼šè¢«åˆå¹¶
4. **ä¼˜å…ˆçº§æ’åº**ï¼šçˆ¶ç»„ä»¶ä¼˜å…ˆäºå­ç»„ä»¶æ›´æ–°

**å®é™…åº”ç”¨ç¤ºä¾‹ï¼š**

```javascript
// ç”¨æˆ·ä»£ç 
function handleClick() {
  this.count++ // è§¦å‘æ›´æ–°1
  this.name = 'new name' // è§¦å‘æ›´æ–°2
  this.list.push(item) // è§¦å‘æ›´æ–°3
}

// Vueå†…éƒ¨å¤„ç†
// 1. ä¸‰ä¸ªæ›´æ–°éƒ½è¢«åŠ å…¥é˜Ÿåˆ—
// 2. åœ¨ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡ä¸­æ‰¹é‡æ‰§è¡Œ
// 3. ç»„ä»¶åªé‡æ–°æ¸²æŸ“ä¸€æ¬¡
```

### 5. å¦‚ä½•è®¾è®¡ä¸€ä¸ªè·¨å¹³å°çš„æ¸²æŸ“å™¨ï¼Ÿ
**æ€è€ƒæ–¹å‘ï¼š**
- æŠ½è±¡å±‚çš„è®¾è®¡
- å¹³å°ç‰¹å®šçš„å®ç°
- APIçš„ç»Ÿä¸€æ€§

**ğŸ“‹ è¯¦ç»†è§£ç­”ï¼š**

**æŠ½è±¡å±‚çš„è®¾è®¡ï¼š**

```javascript
// æ¸²æŸ“å™¨æŠ½è±¡æ¥å£
interface RendererOptions {
  // èŠ‚ç‚¹æ“ä½œ
  createElement(type: string): any
  createText(text: string): any
  createComment(text: string): any
  
  // DOMæ“ä½œ
  insert(child: any, parent: any, anchor?: any): void
  remove(child: any): void
  
  // å±æ€§æ“ä½œ
  patchProp(el: any, key: string, prevValue: any, nextValue: any): void
  
  // æŸ¥è¯¢æ“ä½œ
  parentNode(node: any): any
  nextSibling(node: any): any
  
  // æ–‡æœ¬æ“ä½œ
  setText(node: any, text: string): void
  setElementText(el: any, text: string): void
}

// é€šç”¨æ¸²æŸ“å™¨å·¥å‚
function createRenderer(options: RendererOptions) {
  const {
    createElement,
    createText,
    createComment,
    insert,
    remove,
    patchProp,
    parentNode,
    nextSibling,
    setText,
    setElementText
  } = options
  
  // æ¸²æŸ“å™¨æ ¸å¿ƒé€»è¾‘ï¼ˆå¹³å°æ— å…³ï¼‰
  function patch(n1, n2, container, anchor) {
    // é€šç”¨çš„patché€»è¾‘
  }
  
  function render(vnode, container) {
    if (vnode == null) {
      // å¸è½½
      if (container._vnode) {
        unmount(container._vnode)
      }
    } else {
      // æŒ‚è½½æˆ–æ›´æ–°
      patch(container._vnode || null, vnode, container)
    }
    container._vnode = vnode
  }
  
  return { render, createApp: createAppAPI(render) }
}
```

**å¹³å°ç‰¹å®šçš„å®ç°ï¼š**

```javascript
// æµè§ˆå™¨å¹³å°å®ç°
const domOptions: RendererOptions = {
  createElement: (tag) => document.createElement(tag),
  createText: (text) => document.createTextNode(text),
  createComment: (text) => document.createComment(text),
  
  insert: (child, parent, anchor) => {
    parent.insertBefore(child, anchor || null)
  },
  
  remove: (child) => {
    const parent = child.parentNode
    if (parent) {
      parent.removeChild(child)
    }
  },
  
  patchProp: (el, key, prevValue, nextValue) => {
    // æµè§ˆå™¨ç‰¹å®šçš„å±æ€§æ›´æ–°é€»è¾‘
    if (key === 'class') {
      el.className = nextValue || ''
    } else if (key === 'style') {
      // æ ·å¼æ›´æ–°é€»è¾‘
    } else if (isOn(key)) {
      // äº‹ä»¶å¤„ç†é€»è¾‘
    } else {
      // å…¶ä»–å±æ€§
      el.setAttribute(key, nextValue)
    }
  },
  
  parentNode: (node) => node.parentNode,
  nextSibling: (node) => node.nextSibling,
  setText: (node, text) => node.nodeValue = text,
  setElementText: (el, text) => el.textContent = text
}

// ç§»åŠ¨ç«¯å¹³å°å®ç°ï¼ˆå¦‚React Nativeï¼‰
const nativeOptions: RendererOptions = {
  createElement: (type) => {
    // åˆ›å»ºåŸç”Ÿç»„ä»¶
    return NativeModules.UIManager.createView(type)
  },
  
  insert: (child, parent, anchor) => {
    // åŸç”Ÿè§†å›¾æ’å…¥é€»è¾‘
    NativeModules.UIManager.manageChildren(parent, [child])
  },
  
  patchProp: (el, key, prevValue, nextValue) => {
    // åŸç”Ÿå±æ€§æ›´æ–°é€»è¾‘
    NativeModules.UIManager.updateView(el, { [key]: nextValue })
  },
  
  // ... å…¶ä»–å¹³å°ç‰¹å®šå®ç°
}

// å°ç¨‹åºå¹³å°å®ç°
const miniProgramOptions: RendererOptions = {
  createElement: (type) => {
    // å°ç¨‹åºç»„ä»¶åˆ›å»ºé€»è¾‘
    return { type, props: {}, children: [] }
  },
  
  insert: (child, parent) => {
    // å°ç¨‹åºè§†å›¾æ ‘æ“ä½œ
    parent.children.push(child)
  },
  
  // ... å…¶ä»–å°ç¨‹åºç‰¹å®šå®ç°
}
```

**APIçš„ç»Ÿä¸€æ€§ï¼š**

```javascript
// ç»Ÿä¸€çš„åº”ç”¨åˆ›å»ºAPI
function createApp(rootComponent) {
  const app = {
    _component: rootComponent,
    _container: null,
    
    mount(container) {
      if (!app._container) {
        app._container = container
        const vnode = createVNode(rootComponent)
        render(vnode, container)
      }
    },
    
    unmount() {
      if (app._container) {
        render(null, app._container)
        app._container = null
      }
    },
    
    use(plugin) {
      // æ’ä»¶ç³»ç»Ÿ
      plugin.install(app)
      return app
    }
  }
  
  return app
}

// è·¨å¹³å°ä½¿ç”¨
// æµè§ˆå™¨
const browserRenderer = createRenderer(domOptions)
const browserApp = browserRenderer.createApp(App)
browserApp.mount('#app')

// ç§»åŠ¨ç«¯
const nativeRenderer = createRenderer(nativeOptions)
const nativeApp = nativeRenderer.createApp(App)
nativeApp.mount(rootView)

// å°ç¨‹åº
const miniRenderer = createRenderer(miniProgramOptions)
const miniApp = miniRenderer.createApp(App)
miniApp.mount(pageInstance)
```

**è·¨å¹³å°è®¾è®¡çš„å…³é”®åŸåˆ™ï¼š**

1. **åˆ†ç¦»å…³æ³¨ç‚¹**ï¼šå°†å¹³å°æ— å…³çš„é€»è¾‘ä¸å¹³å°ç‰¹å®šçš„æ“ä½œåˆ†ç¦»
2. **æ¥å£æŠ½è±¡**ï¼šå®šä¹‰æ¸…æ™°çš„æŠ½è±¡æ¥å£ï¼Œéšè—å¹³å°å·®å¼‚
3. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒæ–°å¹³å°çš„æ¥å…¥ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
4. **ä¸€è‡´æ€§**ï¼šä¿è¯ä¸åŒå¹³å°ä¸Šçš„APIå’Œè¡Œä¸ºä¸€è‡´
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šé’ˆå¯¹ä¸åŒå¹³å°çš„ç‰¹æ€§è¿›è¡Œä¼˜åŒ–

## ğŸš€ æ€§èƒ½ä¼˜åŒ–é‡ç‚¹

1. **å‡å°‘è™šæ‹ŸDOMåˆ›å»º** - é™æ€æå‡ã€ç¼“å­˜
2. **ç²¾ç¡®æ›´æ–°** - patch flagsã€é¶å‘æ›´æ–°
3. **é«˜æ•ˆdiff** - ç®—æ³•ä¼˜åŒ–ã€å¯å‘å¼ç­–ç•¥
4. **æ‰¹é‡æ›´æ–°** - å¼‚æ­¥æ›´æ–°é˜Ÿåˆ—
5. **å†…å­˜ä¼˜åŒ–** - å¯¹è±¡æ± ã€å¤ç”¨ç­–ç•¥

## ğŸ“ å®è·µé¡¹ç›®å»ºè®®

åˆ›å»ºä¸€ä¸ªé«˜æ€§èƒ½æ¸²æŸ“å™¨ï¼Œæ”¯æŒï¼š
- å®Œæ•´çš„è™šæ‹ŸDOMç³»ç»Ÿ
- é«˜æ•ˆçš„diffç®—æ³•
- ç»„ä»¶æ¸²æŸ“æ”¯æŒ
- äº‹ä»¶ç³»ç»Ÿ
- åŸºæœ¬çš„æ€§èƒ½ä¼˜åŒ–
- å®Œæ•´çš„æµ‹è¯•è¦†ç›–

å®Œæˆæœ¬é˜¶æ®µå­¦ä¹ åï¼Œè¯·è¿›å…¥[ç¬¬å››é˜¶æ®µï¼šç»„ä»¶ç³»ç»Ÿ](./ç¬¬å››é˜¶æ®µ-ç»„ä»¶ç³»ç»Ÿ.md)ï¼
